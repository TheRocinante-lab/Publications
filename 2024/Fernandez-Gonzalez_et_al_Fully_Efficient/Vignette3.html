<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Vignette 3: Multi-trait analysis</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Vignette 3: Multi-trait analysis</h1>



<p>Libraries for open source:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(Matrix) <span class="co">#all StageWise models in the vignettes work for Matrix package </span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#version 1.5-1. Later versions may cause errors in some of the StageWise models</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(matrixcalc)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(sommer)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(ggforce)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(CVXR)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;Vignette3Models.RData&quot;</span>)</span></code></pre></div>
<p>When citing this work, please ensure to also cite the StageWise
package (Endelman, J. B., 2023). This citation is essential due to the
foundational role of StageWise in the development of these models. For
an in-depth understanding of the fully-efficient two-stage modeling
strategy, we recommend Damesa et al., (2017).</p>
<div id="multi-trait-model" class="section level3">
<h3>Multi-Trait Model</h3>
<p>This section of the package focuses on estimating Best Linear
Unbiased Estimates (BLUEs) in the first stage, incorporating an
unstructured trait covariance matrix for the residuals. Notation
Explained: In our model, the phenotypes for a single environment are
expressed as <span class="math inline">\(y_{ikl}\)</span> where, where
<span class="math inline">\(i\)</span> represents genotype, <span class="math inline">\(k\)</span> is trait, and <span class="math inline">\(l\)</span> represents one or more indices for
treatments, covariates, etc. The model equation is <span class="math display">\[ y_{ikl} = \mu + g_{ik} + \dots + \epsilon_{ikl}
\]</span></p>
<p>Here, the genotype effects <span class="math inline">\(g_{ik}\)</span> are fixed and the residuals <span class="math inline">\(e_{ikl}\)</span> follow a multivariate normal
distribution, with the variance given by <span class="math inline">\(var[\boldsymbol{\epsilon}] = \mathbf{I} \otimes
\boldsymbol\Sigma_\epsilon\)</span>, where <span class="math inline">\(\boldsymbol\Sigma_\epsilon\)</span> is an
unstructured var-cov matrix for traits.</p>
<p>In the second stage, the response variable is <span class="math inline">\(BLUE[g_{ijk}]\)</span>, with <span class="math inline">\(j\)</span> representing the environment. The
Stage2 model, incorporating multivariate normal additive <span class="math inline">\(\boldsymbol{a}\)</span> and dominance <span class="math inline">\(\boldsymbol{d}\)</span> effects.</p>
<p><span class="math display">\[BLUE[g_{ijk}] = E_{jk} + a_{ik} + d_{ik}
- b_k F_i + gE_{ijk} + s_{ijk}\]</span></p>
<p>where <span class="math inline">\(E_{jk}\)</span> is the fixed effect
for environment, and <span class="math inline">\(F_i\)</span> is the
genomic inbreeding coefficient, with regression coefficient <span class="math inline">\(b_k\)</span>. The other effects are multivariate
normal with zero mean and <span class="math inline">\(var[\boldsymbol{a}]=\mathbf{G} \otimes
\boldsymbol\Sigma_a\)</span>, <span class="math inline">\(var[\boldsymbol{d}]=\mathbf{D} \otimes
\boldsymbol\Sigma_d\)</span>, and <span class="math inline">\(var[\boldsymbol{gE}]=\mathbf{I} \otimes
\boldsymbol\Sigma_{gE}\)</span>. The preceding <span class="math inline">\(\boldsymbol\Sigma\)</span> are unstructured
var-cov matrices for traits. The Stage1 error term <span class="math inline">\(\boldsymbol{s}\)</span> is also multivariate
normal, with var-cov matrix equal to the direct sum of the var-cov
matrices (EEV) of the Stage1 BLUEs for each environment.</p>
</div>
<div id="potato-dataset" class="section level3">
<h3>Potato dataset</h3>
<p>In <a href="https://jendelman.github.io/StageWise/Vignette1.html">Vignette
1</a>, three traits (yield, maturity, and fry color) were independently
analyzed in a dataset of 943 potato clones. Due to the large number of
traits in potato breeding, it is impractical to analyze them all jointly
in StageWise. To simplify the analysis, it is suggested to identify
groups of highly correlated traits based on the Stage 1 Best Linear
Unbiased Estimators (BLUEs). This can be accomplished using a simple
loop.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(StageWise)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>pheno.file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;vignette_data&quot;</span>, <span class="st">&quot;pheno1a.csv&quot;</span>, <span class="at">package =</span> <span class="st">&quot;StageWise&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(pheno.file)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>effects <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">name=</span><span class="fu">c</span>(<span class="st">&quot;block&quot;</span>,<span class="st">&quot;stand.count&quot;</span>),</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>                      <span class="at">fixed=</span><span class="fu">c</span>(<span class="cn">FALSE</span>,<span class="cn">TRUE</span>),</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>                      <span class="at">factor=</span><span class="fu">c</span>(<span class="cn">TRUE</span>,<span class="cn">FALSE</span>))</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>traits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;total.yield&quot;</span>,<span class="st">&quot;vine.maturity&quot;</span>,<span class="st">&quot;fry.color&quot;</span>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>n.trait <span class="ot">&lt;-</span> <span class="fu">length</span>(traits)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co">#Single-trait model for each trait</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">#These are the same Stage1 models used in Vignette1</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co">#You can replicate them with lmer as shown in Vignette1</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">#Just use the phenotype of the desired trait as the response variable in the model</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>stage1.blues <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.trait) {</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">Stage1</span>(<span class="at">filename=</span>pheno.file,<span class="at">traits=</span>traits[i],<span class="at">effects=</span>effects)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(stage1.blues)) {</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    stage1.blues <span class="ot">&lt;-</span> <span class="fu">merge</span>(stage1.blues,tmp<span class="sc">$</span>blue,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;env&quot;</span>))</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    stage1.blues <span class="ot">&lt;-</span> tmp<span class="sc">$</span>blue</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  }</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Online License checked out Mon Jun 10 15:28:24 2024</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">colnames</span>(stage1.blues) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;env&quot;</span>,traits)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">head</span>(stage1.blues)</span></code></pre></div>
<pre><code>##           id       env total.yield vine.maturity fry.color
## 1  A00188-3C Hancock15    66.81187      7.730410  48.28063
## 2  A01143-3C Hancock15   104.41187      8.230410  50.88063
## 3  A09037-6C Hancock15    76.55071      4.923612  54.55500
## 4  A11516-1C Hancock18    45.32170      3.003406  51.51364
## 5  A11520-1C Hancock18    61.24219      3.003407  51.15342
## 6 AAF07847-2 Hancock15    83.85071      7.923612  49.65500</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#Calculate correlation matrix for each env</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">lapply</span>(<span class="at">X =</span> <span class="fu">split</span>(stage1.blues,stage1.blues<span class="sc">$</span>env),</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>       <span class="at">FUN =</span> <span class="cf">function</span>(data){<span class="fu">round</span>(<span class="fu">cor</span>(data[,<span class="dv">2</span><span class="sc">+</span><span class="dv">1</span><span class="sc">:</span>n.trait]),<span class="dv">2</span>)})</span></code></pre></div>
<pre><code>## $Hancock15
##               total.yield vine.maturity fry.color
## total.yield          1.00          0.33     -0.03
## vine.maturity        0.33          1.00      0.03
## fry.color           -0.03          0.03      1.00
## 
## $Hancock16
##               total.yield vine.maturity fry.color
## total.yield          1.00          0.40      0.07
## vine.maturity        0.40          1.00      0.04
## fry.color            0.07          0.04      1.00
## 
## $Hancock17
##               total.yield vine.maturity fry.color
## total.yield          1.00          0.45     -0.06
## vine.maturity        0.45          1.00      0.01
## fry.color           -0.06          0.01      1.00
## 
## $Hancock18
##               total.yield vine.maturity fry.color
## total.yield          1.00          0.32      0.11
## vine.maturity        0.32          1.00      0.03
## fry.color            0.11          0.03      1.00
## 
## $Hancock19
##               total.yield vine.maturity fry.color
## total.yield          1.00          0.19     -0.18
## vine.maturity        0.19          1.00      0.05
## fry.color           -0.18          0.05      1.00</code></pre>
<p>The output indicates that, in four out of five years, the phenotypic
correlation between yield and vine maturity exceeded 0.3, while the
correlation between fry color and these traits consistently remained
below 0.2 in magnitude. Consequently, we will initially perform a
correlated trait analysis for yield and maturity, with plans to
incorporate fry color results at a later stage. The syntax for analyzing
multiple traits closely parallels the workflow for a single trait:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">#Multi-trait model for total.yield and vine.maturity</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>ans1 <span class="ot">&lt;-</span> <span class="fu">Stage1</span>(<span class="at">filename=</span>pheno.file,<span class="at">traits=</span><span class="fu">c</span>(<span class="st">&quot;total.yield&quot;</span>,<span class="st">&quot;vine.maturity&quot;</span>),</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>              <span class="at">effects=</span>effects)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="fu">names</span>(ans1)</span></code></pre></div>
<pre><code>## [1] &quot;blues&quot; &quot;vcov&quot;  &quot;fit&quot;   &quot;resid&quot;</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>BLUEs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>EEVs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>Envs <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>n.trait <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co">#we will consider 2 traits in the multi-trait model</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="cf">for</span> (enviro <span class="cf">in</span> <span class="fu">unique</span>(pheno<span class="sc">$</span>env)) {</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="fu">print</span>(enviro)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  phenoenv <span class="ot">&lt;-</span> pheno[pheno<span class="sc">$</span>env <span class="sc">==</span> enviro,]</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="co">#1) remove entries with missing values </span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  phenoenv <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(phenoenv)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  </span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  Envs <span class="ot">&lt;-</span> <span class="fu">c</span>(Envs, <span class="fu">rep</span>(enviro, <span class="fu">length</span>(<span class="fu">unique</span>(phenoenv<span class="sc">$</span>id))))</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  </span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  phenoenv<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">factor</span>(phenoenv<span class="sc">$</span>id)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  phenoenv<span class="sc">$</span>block <span class="ot">&lt;-</span> <span class="fu">factor</span>(phenoenv<span class="sc">$</span>block) <span class="co">#cofactor</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  phenoenv<span class="sc">$</span>stand.count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(phenoenv<span class="sc">$</span>stand.count) <span class="co">#covariate</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  phenoenv<span class="sc">$</span>stand.count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(phenoenv<span class="sc">$</span>stand.count, </span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>                                           <span class="at">scale =</span> <span class="cn">FALSE</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>  <span class="co">#Important to center!</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  <span class="co">#If you don&#39;t center the data, EEV calculation will be massively off!</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  </span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  <span class="co">#remove the intercept in the model!</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="co">#It&#39;s important for correct EEV calculation</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  <span class="co">#Use mmer solver</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  <span class="co">#Using mmec, unstructured Trait structure for residuals failed</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>  models[[enviro]] <span class="ot">&lt;-</span> <span class="fu">mmer</span>(<span class="fu">cbind</span>(total.yield,vine.maturity)<span class="sc">~</span> id <span class="sc">+</span> stand.count <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>                        <span class="at">random=</span><span class="sc">~</span><span class="fu">vsr</span>(block,<span class="at">Gtc=</span><span class="fu">diag</span>(n.trait)),</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>                        <span class="at">rcov=</span><span class="sc">~</span><span class="fu">vsr</span>(units,<span class="at">Gtc=</span><span class="fu">unsm</span>(n.trait)),</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>                        <span class="at">data=</span>phenoenv,</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>                        <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>  AllBetasNames <span class="ot">&lt;-</span>   <span class="fu">paste0</span>(models[[enviro]]<span class="sc">$</span>Beta<span class="sc">$</span>Effect, <span class="st">&quot;:&quot;</span>,</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>                                models[[enviro]]<span class="sc">$</span>Beta<span class="sc">$</span>Trait)</span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>  AllBetasNames <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;^id&quot;</span>, <span class="st">&quot;&quot;</span>,AllBetasNames) <span class="co">#remove the &quot;id&quot; at the beginning</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>  <span class="co">#names for the betas we are not interested in (other fixed effects)</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>  BadBetasNames <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;stand.count&quot;</span>, <span class="st">&quot;:&quot;</span>,</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>                                <span class="fu">unique</span>(models[[enviro]]<span class="sc">$</span>Beta<span class="sc">$</span>Trait))</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>  <span class="co">#names for the betas we are interested in (genotype:trait effect)</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>  BetasToRemove <span class="ot">&lt;-</span> <span class="fu">which</span>(AllBetasNames <span class="sc">%in%</span> BadBetasNames)</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>  GoodBetasNames <span class="ot">&lt;-</span> AllBetasNames[<span class="sc">-</span>BetasToRemove]</span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>  <span class="co">#calculate EEV (estimation error variance-covariance matrix for id effects)</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>  EEV_sommer <span class="ot">&lt;-</span> models[[enviro]]<span class="sc">$</span>VarBeta</span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>  <span class="co">#remove EEV entries for all fixed effects other than id</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>  <span class="co">#in this case, the only fixed effect to remove is stand.count</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>  EEV_sommer <span class="ot">&lt;-</span> EEV_sommer[<span class="sc">-</span>BetasToRemove,<span class="sc">-</span>BetasToRemove]</span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>  <span class="fu">rownames</span>(EEV_sommer) <span class="ot">&lt;-</span> GoodBetasNames</span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>  <span class="fu">colnames</span>(EEV_sommer) <span class="ot">&lt;-</span> GoodBetasNames</span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>  <span class="co">#keep only the BLUEs for the id fixed effect</span></span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>  betassommer <span class="ot">&lt;-</span> models[[enviro]]<span class="sc">$</span>Beta<span class="sc">$</span>Estimate[<span class="sc">-</span>BetasToRemove]</span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>  <span class="fu">names</span>(betassommer)  <span class="ot">&lt;-</span> GoodBetasNames</span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>  BLUEs <span class="ot">&lt;-</span> <span class="fu">c</span>(BLUEs, betassommer)</span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a>  EEVs[[enviro]] <span class="ot">&lt;-</span> EEV_sommer</span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;Hancock15&quot;
## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.[1] &quot;Hancock16&quot;
## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.[1] &quot;Hancock17&quot;
## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.[1] &quot;Hancock18&quot;
## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.[1] &quot;Hancock19&quot;
## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>StageWiseBlues <span class="ot">&lt;-</span> ans1<span class="sc">$</span>blues</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>id.trait <span class="ot">&lt;-</span> <span class="fu">paste0</span>(StageWiseBlues<span class="sc">$</span>id,<span class="st">&quot;:&quot;</span>,StageWiseBlues<span class="sc">$</span>trait)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>StageWiseBlues <span class="ot">&lt;-</span> <span class="fu">cbind</span>(StageWiseBlues, id.trait)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>StageWiseBlues <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(StageWiseBlues)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co">#Very similar BLUEs, but not exactly the same</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  <span class="fu">cor</span>(StageWiseBlues<span class="sc">$</span>BLUE[<span class="fu">match</span>(<span class="fu">names</span>(BLUEs), StageWiseBlues<span class="sc">$</span>id.trait)], <span class="co">#StageWise</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    BLUEs)</span></code></pre></div>
<pre><code>## [1] 0.9820859</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">#Not exactly the same EEV</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>differences <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="cf">for</span> (enviro <span class="cf">in</span> <span class="fu">unique</span>(pheno<span class="sc">$</span>env)) {</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  placeholder <span class="ot">&lt;-</span> ans1<span class="sc">$</span>vcov[[enviro]][<span class="fu">rownames</span>(EEVs[[enviro]]),<span class="fu">colnames</span>(EEVs[[enviro]])]</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  differences <span class="ot">&lt;-</span> <span class="fu">c</span>(differences, <span class="fu">mean</span>(<span class="fu">abs</span>(EEVs[[enviro]] <span class="sc">-</span> placeholder)))</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>differences</span></code></pre></div>
<pre><code>## [1] 3.20428764 0.93744808 0.03769956 0.20959547 0.01083914</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">#merge EEV matrices from each environment for their use in the second stage</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#It is done using the direct sum operator</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="fu">library</span>(matrixcalc)</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>placeholder_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>()</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(pheno<span class="sc">$</span>env))) {</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>  env1 <span class="ot">&lt;-</span> <span class="fu">unique</span>(pheno<span class="sc">$</span>env)[i<span class="dv">-1</span>]</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>  <span class="fu">rownames</span>(EEVs[[env1]]) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rownames</span>(EEVs[[env1]]),<span class="st">&quot;:&quot;</span>,env1)</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>  <span class="fu">colnames</span>(EEVs[[env1]]) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(EEVs[[env1]]),<span class="st">&quot;:&quot;</span>,env1)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>  env2 <span class="ot">&lt;-</span> <span class="fu">unique</span>(pheno<span class="sc">$</span>env)[i]</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  <span class="fu">rownames</span>(EEVs[[env2]]) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rownames</span>(EEVs[[env2]]),<span class="st">&quot;:&quot;</span>,env2)</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>  <span class="fu">colnames</span>(EEVs[[env2]]) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(EEVs[[env2]]),<span class="st">&quot;:&quot;</span>,env2)</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">is.na</span>(placeholder_matrix)) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    placeholder_matrix <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(EEVs[[env1]],EEVs[[env2]])</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>    placeholder_matrix <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(placeholder_matrix,EEVs[[env2]])</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>  }</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>}</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>EEV_full <span class="ot">&lt;-</span> placeholder_matrix</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="fu">colnames</span>(EEV_full) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(EEV_full)</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="co">#There are more BLUEs in StageWise than in Sommer because Sommer removes all </span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="co">#genotypes that have a missing value for some but not all traits, while StageWise</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="co">#keeps the non-missing genotype-trait combinations</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a><span class="fu">dim</span>(EEV_full) <span class="co">#Sommer</span></span></code></pre></div>
<pre><code>## [1] 2594 2594</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">length</span>(BLUEs) <span class="co">#Sommer</span></span></code></pre></div>
<pre><code>## [1] 2594</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">na.omit</span>(ans1<span class="sc">$</span>blues)) <span class="co">#StageWise</span></span></code></pre></div>
<pre><code>## [1] 2635    4</code></pre>
<p>Similar to the single-trait analysis, <code>Stage1</code> generates a
data frame of BLUEs and a list of their variance-covariance matrices.
However, in place of residual diagnostic plots, the function returns
residual covariance matrices under the name “resid.” Below is the code
for conducting Stage 2 analysis with directional dominance:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>geno.file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;vignette_data&quot;</span>, <span class="st">&quot;geno1.csv&quot;</span>, <span class="at">package =</span> <span class="st">&quot;StageWise&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>geno <span class="ot">&lt;-</span> <span class="fu">read_geno</span>(geno.file,<span class="at">ploidy=</span><span class="dv">4</span>,<span class="at">map=</span><span class="cn">TRUE</span>,<span class="at">dominance =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Minor allele threshold = 5 genotypes
## Number of markers = 12242
## Number of genotypes = 943</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>ans2 <span class="ot">&lt;-</span> <span class="fu">Stage2</span>(<span class="at">data=</span>ans1<span class="sc">$</span>blue, <span class="at">vcov=</span>ans1<span class="sc">$</span>vcov, <span class="at">geno=</span>geno, <span class="at">non.add=</span><span class="st">&quot;dom&quot;</span>,</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>               <span class="at">silent=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">summary</span>(ans2<span class="sc">$</span>vars)</span></code></pre></div>
<pre><code>## $var
##              total.yield vine.maturity
## env                 67.7         0.495
## additive            41.4         0.999
## dominance           26.5         0.201
## heterosis            3.9         0.007
## g x env             43.0         0.461
## Stage1.error        31.9         0.998
## 
## $PVE
##              total.yield vine.maturity
## additive           0.282         0.375
## dominance          0.181         0.075
## heterosis          0.026         0.002
## g x env            0.293         0.173
## Stage1.error       0.218         0.375
## 
## $cor.mat
##               total.yield vine.maturity
## total.yield         1.000         0.522
## vine.maturity       0.522         1.000</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co">#Dataframe in long format </span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>placeholder <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">names</span>(BLUEs), <span class="st">&quot;:&quot;</span>))</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>GIDs <span class="ot">&lt;-</span> placeholder[<span class="fu">seq</span>(<span class="dv">1</span>,<span class="fu">length</span>(placeholder), <span class="at">by =</span> <span class="dv">2</span>)]</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>traits <span class="ot">&lt;-</span> placeholder[<span class="fu">seq</span>(<span class="dv">2</span>,<span class="fu">length</span>(placeholder), <span class="at">by =</span> <span class="dv">2</span>)]</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>Envs_large <span class="ot">&lt;-</span> <span class="fu">rep</span>(Envs, <span class="at">each=</span>n.trait)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>Stage1Output <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">BLUEs =</span> BLUEs,</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>                       <span class="at">id =</span> GIDs,</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>                       <span class="at">Trait =</span> traits,</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>                       <span class="at">Env =</span> Envs_large)</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">#to wide format</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>sommerdf<span class="ot">&lt;-</span><span class="fu">reshape</span>(Stage1Output,<span class="at">idvar=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;Env&quot;</span>),</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>              <span class="at">v.names=</span><span class="fu">c</span>(<span class="st">&quot;BLUEs&quot;</span>),<span class="at">direction=</span><span class="st">&quot;wide&quot;</span>,<span class="at">timevar=</span><span class="st">&quot;Trait&quot;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="co">#We need to add to Stage1Output a column for the id of stage 1 estimation error</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a><span class="co">#There&#39;s a different Stage1Error column for each trait</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a><span class="cf">for</span> (trait <span class="cf">in</span> <span class="fu">unique</span>(traits)) {</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>  Stage1Error <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sommerdf<span class="sc">$</span>id,<span class="st">&quot;:&quot;</span>,trait,<span class="st">&quot;:&quot;</span>,sommerdf<span class="sc">$</span>Env)</span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>  <span class="co">#We need a column for BLUEs, environment name, genotypic id and stage1error</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>  sommerdf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sommerdf,</span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>                  Stage1Error)</span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>  <span class="fu">colnames</span>(sommerdf)[<span class="fu">ncol</span>(sommerdf)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(trait,<span class="st">&quot;.Stage1Error&quot;</span>)</span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>}</span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" tabindex="-1"></a>genotyped_id <span class="ot">&lt;-</span> <span class="fu">unique</span>(sommerdf<span class="sc">$</span>id)[<span class="fu">unique</span>(sommerdf<span class="sc">$</span>id) <span class="sc">%in%</span> <span class="fu">rownames</span>(geno<span class="sc">@</span>G)]</span>
<span id="cb26-32"><a href="#cb26-32" tabindex="-1"></a>non_genotyped_id <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">unique</span>(sommerdf<span class="sc">$</span>id), genotyped_id)</span>
<span id="cb26-33"><a href="#cb26-33" tabindex="-1"></a>sommerdf <span class="ot">&lt;-</span> sommerdf[<span class="sc">-</span><span class="fu">which</span>(sommerdf<span class="sc">$</span>id <span class="sc">%in%</span> non_genotyped_id),]</span>
<span id="cb26-34"><a href="#cb26-34" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" tabindex="-1"></a><span class="co">#include Fg into sommerdf:</span></span>
<span id="cb26-38"><a href="#cb26-38" tabindex="-1"></a>Fg <span class="ot">&lt;-</span> geno<span class="sc">@</span>Fg</span>
<span id="cb26-39"><a href="#cb26-39" tabindex="-1"></a><span class="co">#1) reorder</span></span>
<span id="cb26-40"><a href="#cb26-40" tabindex="-1"></a>Fg <span class="ot">&lt;-</span> Fg[<span class="fu">match</span>(sommerdf<span class="sc">$</span>id, <span class="fu">names</span>(Fg))]</span>
<span id="cb26-41"><a href="#cb26-41" tabindex="-1"></a><span class="fu">identical</span>(sommerdf<span class="sc">$</span>id, <span class="fu">names</span>(Fg))</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>sommerdf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sommerdf, Fg)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>EEV.yield <span class="ot">&lt;-</span> EEV_full[sommerdf<span class="sc">$</span>total.yield.Stage1Error,</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>                        sommerdf<span class="sc">$</span>total.yield.Stage1Error]</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>EEV.maturity <span class="ot">&lt;-</span> EEV_full[sommerdf<span class="sc">$</span>vine.maturity.Stage1Error,</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>                           sommerdf<span class="sc">$</span>vine.maturity.Stage1Error]</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>domId <span class="ot">&lt;-</span> sommerdf<span class="sc">$</span>id</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>sommerdf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sommerdf, domId) <span class="co">#id with a different column name to allow to have</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="co">#different id effects for dominance and additive</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>ans2open <span class="ot">&lt;-</span> <span class="fu">mmer</span>(<span class="fu">cbind</span>(BLUEs.total.yield,BLUEs.vine.maturity) <span class="sc">~</span> Env <span class="sc">+</span> Fg <span class="sc">-</span><span class="dv">1</span>, <span class="co">#Fixed </span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>                     <span class="at">random =</span> <span class="sc">~</span><span class="fu">vsr</span>(id, </span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>                                   <span class="at">Gtc=</span><span class="fu">unsm</span>(n.trait), <span class="co">#unstructured</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>                                   <span class="co">#variance-covariance matrix for the traits</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>                                   <span class="at">Gu =</span> <span class="fu">as.matrix</span>(geno<span class="sc">@</span>G)) <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>                      <span class="co">#id (genotypic effect) with the default</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>                       <span class="fu">vsr</span>(domId, </span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>                           <span class="at">Gtc=</span><span class="fu">unsm</span>(n.trait), <span class="co">#unstructured</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>                                   <span class="co">#variance-covariance matrix for the traits</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>                           <span class="at">Gu =</span> <span class="fu">as.matrix</span>(geno<span class="sc">@</span>D)) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>                       <span class="fu">vsr</span>(total.yield.Stage1Error, <span class="co">#Stage1Error for yield</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>                           <span class="at">Gu=</span>EEV.yield, <span class="co">#known variance-covariance structure</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>                           <span class="at">Gti=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">var</span>(sommerdf<span class="sc">$</span>BLUEs.total.yield),<span class="dv">0</span>,</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">0</span>),<span class="at">nrow=</span><span class="dv">2</span>), <span class="co">#initial</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>                                <span class="co">#variance value. It&#39;s divided by the variance</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>                                <span class="co">#of the BLUEs because Sommer uses varainces</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>                                <span class="co">#scaled that way</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>                           <span class="at">Gtc=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">0</span>),<span class="at">nrow=</span><span class="dv">2</span>)) <span class="sc">+</span> <span class="co">#only estimate variance of </span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>                          <span class="co">#this term for the first trait (yield)</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>                       <span class="fu">vsr</span>(vine.maturity.Stage1Error, <span class="co">#Stage1Error for maturity</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>                           <span class="at">Gu=</span>EEV.maturity, <span class="co">#known variance-covariance structure</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>                           <span class="at">Gti=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">var</span>(sommerdf<span class="sc">$</span>BLUEs.vine.maturity)),<span class="at">nrow=</span><span class="dv">2</span>), <span class="co">#initial</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>                                <span class="co">#variance value. It&#39;s divided by the variance</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>                                <span class="co">#of the BLUEs because Sommer uses varainces</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a>                                <span class="co">#scaled that way</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>                           <span class="at">Gtc=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">3</span>),<span class="at">nrow=</span><span class="dv">2</span>)), <span class="co">#only estimate variance of </span></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>                           <span class="co">#this term for the second trait (maturity)</span></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>                 </span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>                     <span class="at">rcov=</span><span class="sc">~</span><span class="fu">vsr</span>(units,<span class="at">Gtc=</span><span class="fu">unsm</span>(n.trait)),</span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a>                     <span class="at">data=</span> sommerdf,</span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co">#needed later to scale variances</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>meanG <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diag</span>(geno<span class="sc">@</span>G))<span class="sc">-</span><span class="fu">mean</span>(geno<span class="sc">@</span>G)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>meanD <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diag</span>(geno<span class="sc">@</span>D))<span class="sc">-</span><span class="fu">mean</span>(geno<span class="sc">@</span>D)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="co">#calculate fixed effect variance in Sommer as variance of X%*%beta</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>Xenv <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(id<span class="sc">~</span>Env<span class="dv">-1</span>, <span class="at">data=</span>sommerdf)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>fixed.yield <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>Beta[<span class="fu">which</span>(ans2open<span class="sc">$</span>Beta<span class="sc">$</span>Trait <span class="sc">==</span> <span class="st">&quot;BLUEs.total.yield&quot;</span>),] </span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>Env.yield <span class="ot">&lt;-</span> fixed.yield<span class="sc">$</span>Estimate[<span class="fu">which</span>(fixed.yield<span class="sc">$</span>Effect <span class="sc">%in%</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>                                            <span class="fu">paste0</span>(<span class="st">&quot;Env&quot;</span>,sommerdf<span class="sc">$</span>Env))] </span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>Env.yield.var <span class="ot">&lt;-</span> <span class="fu">var</span>(Xenv<span class="sc">%*%</span>Env.yield)</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a><span class="co">#calculate fixed effect variance in Sommer as variance of X%*%beta</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>Xenv <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(id<span class="sc">~</span>Env<span class="dv">-1</span>, <span class="at">data=</span>sommerdf)</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>fixed.maturity <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>Beta[<span class="fu">which</span>(ans2open<span class="sc">$</span>Beta<span class="sc">$</span>Trait <span class="sc">==</span> <span class="st">&quot;BLUEs.vine.maturity&quot;</span>),] </span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>Env.maturity <span class="ot">&lt;-</span> fixed.maturity<span class="sc">$</span>Estimate[<span class="fu">which</span>(fixed.maturity<span class="sc">$</span>Effect <span class="sc">%in%</span></span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>                                            <span class="fu">paste0</span>(<span class="st">&quot;Env&quot;</span>,sommerdf<span class="sc">$</span>Env))] </span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>Env.maturity.var <span class="ot">&lt;-</span> <span class="fu">var</span>(Xenv<span class="sc">%*%</span>Env.maturity)</span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a><span class="co">#Heterosis effects for each genotype can be extracted directly from the &#39;geno&#39;</span></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a><span class="co">#data rather than relying on the model. In the model, there are duplicated &#39;Fg&#39;</span></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a><span class="co">#coefficients for genotypes with multiple Best Linear Unbiased Estimators (BLUEs)</span></span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a><span class="co">#due to their presence in multiple environments. Additionally, genotypes that</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a><span class="co">#were not phenotyped and have no BLUEs do not have &#39;Fg&#39; coefficients in the model.</span></span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a><span class="co">#Extracting &#39;Fg&#39; from &#39;geno&#39; avoids these issues.</span></span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a>XFg <span class="ot">&lt;-</span> geno<span class="sc">@</span>Fg</span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a>Fg.yield <span class="ot">&lt;-</span> fixed.yield<span class="sc">$</span>Estimate[<span class="fu">which</span>(fixed.yield<span class="sc">$</span>Effect <span class="sc">==</span> <span class="st">&quot;Fg&quot;</span>)] </span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a>heterosis.yield <span class="ot">&lt;-</span> XFg<span class="sc">*</span>Fg.yield</span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a><span class="co">#reorder heterosis effects to be in the same order as BLUPs</span></span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a>heterosis.yield <span class="ot">&lt;-</span> heterosis.yield[<span class="fu">match</span>(<span class="fu">names</span>(ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.total.yield),</span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a>                        <span class="fu">names</span>(heterosis.yield))]</span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a>Fg.yield.var <span class="ot">&lt;-</span> <span class="fu">var</span>(heterosis.yield)</span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a>Fg.maturity <span class="ot">&lt;-</span> fixed.maturity<span class="sc">$</span>Estimate[<span class="fu">which</span>(fixed.maturity<span class="sc">$</span>Effect <span class="sc">==</span> <span class="st">&quot;Fg&quot;</span>)] </span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a>heterosis.maturity <span class="ot">&lt;-</span> XFg<span class="sc">*</span>Fg.maturity</span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a><span class="co">#reorder heterosis effects to be in the same order as BLUPs</span></span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a>heterosis.maturity<span class="ot">&lt;-</span>heterosis.maturity[<span class="fu">match</span>(<span class="fu">names</span>(ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.vine.maturity),</span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a>                        <span class="fu">names</span>(heterosis.maturity))]</span>
<span id="cb30-39"><a href="#cb30-39" tabindex="-1"></a>Fg.maturity.var <span class="ot">&lt;-</span> <span class="fu">var</span>(heterosis.maturity)</span>
<span id="cb30-40"><a href="#cb30-40" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" tabindex="-1"></a><span class="co">#Put Everything together in a dataframe</span></span>
<span id="cb30-42"><a href="#cb30-42" tabindex="-1"></a>SommerVars <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">total.yield =</span> <span class="fu">c</span>(Env.yield.var,</span>
<span id="cb30-43"><a href="#cb30-43" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>[<span class="st">&quot;BLUEs.total.yield&quot;</span>,</span>
<span id="cb30-44"><a href="#cb30-44" tabindex="-1"></a>                                                <span class="st">&quot;BLUEs.total.yield&quot;</span>]<span class="sc">*</span>meanG,</span>
<span id="cb30-45"><a href="#cb30-45" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:domId</span><span class="st">`</span>[<span class="st">&quot;BLUEs.total.yield&quot;</span>,</span>
<span id="cb30-46"><a href="#cb30-46" tabindex="-1"></a>                                                  <span class="st">&quot;BLUEs.total.yield&quot;</span>]<span class="sc">*</span>meanD,</span>
<span id="cb30-47"><a href="#cb30-47" tabindex="-1"></a>                          Fg.yield.var,</span>
<span id="cb30-48"><a href="#cb30-48" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:units</span><span class="st">`</span>[<span class="st">&quot;BLUEs.total.yield&quot;</span>,</span>
<span id="cb30-49"><a href="#cb30-49" tabindex="-1"></a>                                                  <span class="st">&quot;BLUEs.total.yield&quot;</span>],</span>
<span id="cb30-50"><a href="#cb30-50" tabindex="-1"></a>                          <span class="fu">mean</span>(<span class="fu">diag</span>(EEV.yield))<span class="sc">-</span> <span class="fu">mean</span>(EEV.yield)),</span>
<span id="cb30-51"><a href="#cb30-51" tabindex="-1"></a>                         </span>
<span id="cb30-52"><a href="#cb30-52" tabindex="-1"></a>                         <span class="at">vine.maturity =</span> <span class="fu">c</span>(Env.maturity.var,</span>
<span id="cb30-53"><a href="#cb30-53" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>[<span class="st">&quot;BLUEs.vine.maturity&quot;</span>,</span>
<span id="cb30-54"><a href="#cb30-54" tabindex="-1"></a>                                                <span class="st">&quot;BLUEs.vine.maturity&quot;</span>]<span class="sc">*</span>meanG,</span>
<span id="cb30-55"><a href="#cb30-55" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:domId</span><span class="st">`</span>[<span class="st">&quot;BLUEs.vine.maturity&quot;</span>,</span>
<span id="cb30-56"><a href="#cb30-56" tabindex="-1"></a>                                                  <span class="st">&quot;BLUEs.vine.maturity&quot;</span>]<span class="sc">*</span>meanD,</span>
<span id="cb30-57"><a href="#cb30-57" tabindex="-1"></a>                          Fg.maturity.var,</span>
<span id="cb30-58"><a href="#cb30-58" tabindex="-1"></a>                          ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:units</span><span class="st">`</span>[<span class="st">&quot;BLUEs.vine.maturity&quot;</span>,</span>
<span id="cb30-59"><a href="#cb30-59" tabindex="-1"></a>                                                  <span class="st">&quot;BLUEs.vine.maturity&quot;</span>],</span>
<span id="cb30-60"><a href="#cb30-60" tabindex="-1"></a>                          <span class="fu">mean</span>(<span class="fu">diag</span>(EEV.maturity))<span class="sc">-</span> <span class="fu">mean</span>(EEV.maturity))</span>
<span id="cb30-61"><a href="#cb30-61" tabindex="-1"></a>                         )</span>
<span id="cb30-62"><a href="#cb30-62" tabindex="-1"></a>ASRemlVars <span class="ot">&lt;-</span> <span class="fu">summary</span>(ans2<span class="sc">$</span>vars)<span class="sc">$</span>var</span>
<span id="cb30-63"><a href="#cb30-63" tabindex="-1"></a><span class="fu">colnames</span>(SommerVars) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;Sommer:&quot;</span>, <span class="fu">colnames</span>(SommerVars))</span>
<span id="cb30-64"><a href="#cb30-64" tabindex="-1"></a><span class="fu">colnames</span>(ASRemlVars) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;ASReml:&quot;</span>, <span class="fu">colnames</span>(ASRemlVars))</span>
<span id="cb30-65"><a href="#cb30-65" tabindex="-1"></a></span>
<span id="cb30-66"><a href="#cb30-66" tabindex="-1"></a>variances_ans2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(SommerVars, ASRemlVars)</span>
<span id="cb30-67"><a href="#cb30-67" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" tabindex="-1"></a><span class="co">#Very similar variances with Sommer and ASReml </span></span>
<span id="cb30-69"><a href="#cb30-69" tabindex="-1"></a>variances_ans2</span></code></pre></div>
<pre><code>##              Sommer:total.yield Sommer:vine.maturity ASReml:total.yield
## env                   68.719019          0.508422949               67.7
## additive              45.192377          1.037530006               41.4
## dominance             26.251025          0.210609738               26.5
## heterosis              4.344874          0.007126912                3.9
## g x env               22.744611          0.417634258               43.0
## Stage1.error          33.472890          0.900433080               31.9
##              ASReml:vine.maturity
## env                         0.495
## additive                    0.999
## dominance                   0.201
## heterosis                   0.007
## g x env                     0.461
## Stage1.error                0.998</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co">#The AIC values differ significantly between the models. This disparity arises </span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="co">#from substantial differences in likelihood values between the &#39;mmer()&#39;</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="co">#solver and the &#39;mmec()&#39; solver, as well as ASReml.</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>ans2<span class="sc">$</span>aic</span></code></pre></div>
<pre><code>## [1] 6660.005</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>ans2open<span class="sc">$</span>AIC</span></code></pre></div>
<pre><code>## [1] 938.9795</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co">#Genotypic values (with dominance)</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>SommerBLUPs.yield <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.total.yield <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>              ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:domId</span><span class="st">`</span><span class="sc">$</span>BLUEs.total.yield <span class="sc">+</span> </span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>              heterosis.yield <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a>              <span class="fu">mean</span>(Env.yield)</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="co">#Breeding values (no dominance). Don&#39;t add environment, leave them centered at 0</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a>SommerBVs.yield <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.total.yield <span class="co">#+</span></span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a>             <span class="co"># mean(Env.yield)</span></span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a>SommerBLUPs.maturity <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.vine.maturity <span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a>              ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:domId</span><span class="st">`</span><span class="sc">$</span>BLUEs.vine.maturity <span class="sc">+</span> </span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a>              heterosis.maturity <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13" tabindex="-1"></a>              <span class="fu">mean</span>(Env.maturity)</span>
<span id="cb36-14"><a href="#cb36-14" tabindex="-1"></a><span class="co">#Breeding values (no dominance). Don&#39;t add environment, leave them centered at 0</span></span>
<span id="cb36-15"><a href="#cb36-15" tabindex="-1"></a>SommerBVs.maturity <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>U<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span><span class="sc">$</span>BLUEs.vine.maturity <span class="co">#+</span></span>
<span id="cb36-16"><a href="#cb36-16" tabindex="-1"></a>              <span class="co">#mean(Env.maturity)</span></span>
<span id="cb36-17"><a href="#cb36-17" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" tabindex="-1"></a><span class="co">#StageWise</span></span>
<span id="cb36-20"><a href="#cb36-20" tabindex="-1"></a>prep1 <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(ans1<span class="sc">$</span>blues, <span class="at">vcov=</span>ans1<span class="sc">$</span>vcov, <span class="at">geno=</span>geno,<span class="at">vars=</span>ans2<span class="sc">$</span>vars)</span>
<span id="cb36-21"><a href="#cb36-21" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" tabindex="-1"></a>index1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">total.yield=</span><span class="dv">1</span>, <span class="at">vine.maturity=</span><span class="dv">0</span>)</span>
<span id="cb36-23"><a href="#cb36-23" tabindex="-1"></a>ASRemlBLUPs.yield <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep1, geno, <span class="at">what=</span><span class="st">&quot;GV&quot;</span>, <span class="at">index.coeff=</span>index1)</span>
<span id="cb36-24"><a href="#cb36-24" tabindex="-1"></a>index2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">total.yield=</span><span class="dv">0</span>, <span class="at">vine.maturity=</span><span class="dv">1</span>)</span>
<span id="cb36-25"><a href="#cb36-25" tabindex="-1"></a>ASRemlBLUPs.maturity <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep1, geno, <span class="at">what=</span><span class="st">&quot;GV&quot;</span>, <span class="at">index.coeff=</span>index2)</span>
<span id="cb36-26"><a href="#cb36-26" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" tabindex="-1"></a><span class="co">#Extremely similar BLUPs</span></span>
<span id="cb36-28"><a href="#cb36-28" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.yield<span class="sc">$</span>value, <span class="co">#StageWise</span></span>
<span id="cb36-29"><a href="#cb36-29" tabindex="-1"></a>SommerBLUPs.yield[<span class="fu">match</span>(ASRemlBLUPs.yield<span class="sc">$</span>id,<span class="fu">names</span>(SommerBLUPs.yield))]) <span class="co">#Sommer</span></span></code></pre></div>
<pre><code>## [1] 0.9932038</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.maturity<span class="sc">$</span>value, <span class="co">#StageWise</span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>SommerBLUPs.maturity[<span class="fu">match</span>(ASRemlBLUPs.maturity<span class="sc">$</span>id,<span class="fu">names</span>(SommerBLUPs.maturity))]) <span class="co">#Sommer</span></span></code></pre></div>
<pre><code>## [1] 0.9851505</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co">#Trait correlation:</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="co">#Sommer:</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a><span class="co">#Trait correlation in additive effects:</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="fu">cov2cor</span>(ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>)</span></code></pre></div>
<pre><code>##                     BLUEs.total.yield BLUEs.vine.maturity
## BLUEs.total.yield           1.0000000           0.5147418
## BLUEs.vine.maturity         0.5147418           1.0000000</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co">#Trait correlation in dominance effects:</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="fu">cov2cor</span>(ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:domId</span><span class="st">`</span>)</span></code></pre></div>
<pre><code>##                     BLUEs.total.yield BLUEs.vine.maturity
## BLUEs.total.yield           1.0000000           0.8490195
## BLUEs.vine.maturity         0.8490195           1.0000000</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="co">#Residual trait correlation:</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="fu">cov2cor</span>(ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:units</span><span class="st">`</span>)</span></code></pre></div>
<pre><code>##                     BLUEs.total.yield BLUEs.vine.maturity
## BLUEs.total.yield           1.0000000           0.5341977
## BLUEs.vine.maturity         0.5341977           1.0000000</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="co">#ASReml:</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a><span class="co">#trait correlation:</span></span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a><span class="fu">summary</span>(ans2<span class="sc">$</span>vars)<span class="sc">$</span>cor.mat</span></code></pre></div>
<pre><code>##               total.yield vine.maturity
## total.yield         1.000         0.522
## vine.maturity       0.522         1.000</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co">#Example of masking for predicting one trait from another with known covariances</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>sommerdf2 <span class="ot">&lt;-</span> sommerdf</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>sommerdf2<span class="sc">$</span>BLUEs.total.yield <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="co">#pivot longer</span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>sommerdf_long<span class="ot">&lt;-</span><span class="fu">reshape</span>(sommerdf2,<span class="at">idvar=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;Env&quot;</span>),</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>                       <span class="at">varying =</span> <span class="fu">c</span>(<span class="st">&quot;BLUEs.total.yield&quot;</span>,</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>                                   <span class="st">&quot;BLUEs.vine.maturity&quot;</span>),</span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a>              <span class="at">v.names=</span><span class="fu">c</span>(<span class="st">&quot;BLUEs&quot;</span>),<span class="at">direction=</span><span class="st">&quot;long&quot;</span>,<span class="at">timevar=</span><span class="st">&quot;Trait&quot;</span>)</span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a>sommerdf_long<span class="sc">$</span>Trait[<span class="fu">which</span>(sommerdf_long<span class="sc">$</span>Trait <span class="sc">==</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="st">&quot;total.yield&quot;</span></span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a>sommerdf_long<span class="sc">$</span>Trait[<span class="fu">which</span>(sommerdf_long<span class="sc">$</span>Trait <span class="sc">==</span> <span class="dv">2</span>)] <span class="ot">&lt;-</span> <span class="st">&quot;vine.maturity&quot;</span></span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a><span class="co">#remove unnecessary columns</span></span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a>sommerdf_long <span class="ot">&lt;-</span> sommerdf_long[,<span class="sc">-</span><span class="fu">which</span>(<span class="fu">colnames</span>(sommerdf_long) <span class="sc">%in%</span></span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a>                                                  <span class="fu">c</span>(<span class="st">&quot;total.yield.Stage1Error&quot;</span>,</span>
<span id="cb48-15"><a href="#cb48-15" tabindex="-1"></a>                                                    <span class="st">&quot;vine.maturity.Stage1Error&quot;</span>,</span>
<span id="cb48-16"><a href="#cb48-16" tabindex="-1"></a>                                                    <span class="st">&quot;domId&quot;</span>))]</span>
<span id="cb48-17"><a href="#cb48-17" tabindex="-1"></a>Stage1Error <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sommerdf_long<span class="sc">$</span>id,<span class="st">&quot;:&quot;</span>,</span>
<span id="cb48-18"><a href="#cb48-18" tabindex="-1"></a>                         sommerdf_long<span class="sc">$</span>Trait,<span class="st">&quot;:&quot;</span>,</span>
<span id="cb48-19"><a href="#cb48-19" tabindex="-1"></a>                         sommerdf_long<span class="sc">$</span>Env)</span>
<span id="cb48-20"><a href="#cb48-20" tabindex="-1"></a>sommerdf_long <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sommerdf_long, Stage1Error)</span>
<span id="cb48-21"><a href="#cb48-21" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" tabindex="-1"></a><span class="fu">rownames</span>(sommerdf_long) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb48-23"><a href="#cb48-23" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" tabindex="-1"></a><span class="co">#reorder by trait (it makes building the EEV matrices easier)</span></span>
<span id="cb48-26"><a href="#cb48-26" tabindex="-1"></a>sommerdf_long <span class="ot">&lt;-</span> sommerdf_long[<span class="fu">order</span>(sommerdf_long<span class="sc">$</span>Trait),]</span>
<span id="cb48-27"><a href="#cb48-27" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" tabindex="-1"></a>TraitId <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;BLUEs.&quot;</span>,sommerdf_long<span class="sc">$</span>Trait, <span class="st">&quot;:&quot;</span>, sommerdf_long<span class="sc">$</span>id)</span>
<span id="cb48-29"><a href="#cb48-29" tabindex="-1"></a>sommerdf_long <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sommerdf_long, TraitId)</span>
<span id="cb48-30"><a href="#cb48-30" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" tabindex="-1"></a>TxG <span class="ot">&lt;-</span> <span class="fu">kronecker</span>(ans2open<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>,geno<span class="sc">@</span>G, <span class="at">make.dimnames =</span> T)</span>
<span id="cb48-33"><a href="#cb48-33" tabindex="-1"></a>TxGinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(TxG)),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb48-34"><a href="#cb48-34" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" tabindex="-1"></a>TxD <span class="ot">&lt;-</span> <span class="fu">kronecker</span>(ans2open<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>,geno<span class="sc">@</span>D, <span class="at">make.dimnames =</span> T)</span>
<span id="cb48-36"><a href="#cb48-36" tabindex="-1"></a>TxDinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(TxD)),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb48-37"><a href="#cb48-37" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" tabindex="-1"></a>EEV_combined <span class="ot">&lt;-</span></span>
<span id="cb48-40"><a href="#cb48-40" tabindex="-1"></a>  <span class="fu">direct.sum</span>(ans2open<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:total.yield.Stage1Error</span><span class="st">`</span>[<span class="dv">2</span>,<span class="dv">2</span>]<span class="sc">*</span>EEV.yield, </span>
<span id="cb48-41"><a href="#cb48-41" tabindex="-1"></a>             ans2open<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:vine.maturity.Stage1Error</span><span class="st">`</span>[<span class="dv">2</span>,<span class="dv">2</span>]<span class="sc">*</span>EEV.maturity)</span>
<span id="cb48-42"><a href="#cb48-42" tabindex="-1"></a><span class="fu">colnames</span>(EEV_combined) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(EEV_combined)</span>
<span id="cb48-43"><a href="#cb48-43" tabindex="-1"></a>EEVinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(EEV_combined)<span class="sc">+</span><span class="fl">1e-6</span><span class="sc">*</span><span class="fu">diag</span>(<span class="fu">nrow</span>(EEV_combined))),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb48-44"><a href="#cb48-44" tabindex="-1"></a></span>
<span id="cb48-45"><a href="#cb48-45" tabindex="-1"></a>Rmat <span class="ot">&lt;-</span> ans2open<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:units</span><span class="st">`</span>[<span class="fu">paste0</span>(<span class="st">&quot;BLUEs.&quot;</span>,sommerdf_long<span class="sc">$</span>Trait),</span>
<span id="cb48-46"><a href="#cb48-46" tabindex="-1"></a>                                        <span class="fu">paste0</span>(<span class="st">&quot;BLUEs.&quot;</span>,sommerdf_long<span class="sc">$</span>Trait)]</span>
<span id="cb48-47"><a href="#cb48-47" tabindex="-1"></a>Rinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(Rmat)<span class="sc">+</span><span class="fl">1e-6</span><span class="sc">*</span><span class="fu">diag</span>(<span class="fu">nrow</span>(Rmat))),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb48-48"><a href="#cb48-48" tabindex="-1"></a><span class="fu">rownames</span>(Rinv) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;u&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Rinv)) <span class="co">#sommer naming convention for residuals</span></span>
<span id="cb48-49"><a href="#cb48-49" tabindex="-1"></a><span class="fu">colnames</span>(Rinv) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;u&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Rinv)) <span class="co">#sommer naming convention for residuals</span></span>
<span id="cb48-50"><a href="#cb48-50" tabindex="-1"></a></span>
<span id="cb48-51"><a href="#cb48-51" tabindex="-1"></a><span class="fu">dim</span>(sommerdf_long)</span></code></pre></div>
<pre><code>## [1] 1800    7</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="fu">dim</span>(EEV_combined)</span></code></pre></div>
<pre><code>## [1] 1800 1800</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="fu">dim</span>(Rmat)</span></code></pre></div>
<pre><code>## [1] 1800 1800</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="fu">dim</span>(TxG)</span></code></pre></div>
<pre><code>## [1] 1886 1886</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(sommerdf_long<span class="sc">$</span>TraitId))</span></code></pre></div>
<pre><code>## [1] 1362</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="co">#Fix all variances</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a><span class="co"># Input known variance-covariance structures estimated from the previous model</span></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a><span class="co"># We&#39;re using &#39;mmec&#39; solver here because &#39;mmer&#39; doesn&#39;t allow to fix the residual variance.</span></span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>ans2mask <span class="ot">&lt;-</span> <span class="fu">mmec</span>(BLUEs <span class="sc">~</span> Env <span class="sc">+</span> Fg <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a>                     <span class="at">random =</span> <span class="sc">~</span><span class="fu">vsc</span>(<span class="fu">isc</span>(TraitId,</span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),<span class="co">#1 instead of Variance_scaled</span></span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a>                                   <span class="co">#because in TxGinv we already used the scaled</span></span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a>                                   <span class="co">#variance and covariance values</span></span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a>                                  <span class="at">Gu =</span> TxGinv) <span class="sc">+</span> <span class="co">#addtitive genotypic</span></span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a>                                <span class="co">#effects</span></span>
<span id="cb58-13"><a href="#cb58-13" tabindex="-1"></a>                               <span class="fu">vsc</span>(<span class="fu">isc</span>(TraitId,</span>
<span id="cb58-14"><a href="#cb58-14" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),<span class="co">#1 instead of Variance_scaled</span></span>
<span id="cb58-15"><a href="#cb58-15" tabindex="-1"></a>                                    <span class="co">#because in TxDinv we already used the scaled</span></span>
<span id="cb58-16"><a href="#cb58-16" tabindex="-1"></a>                                    <span class="co">#variance and covariance values</span></span>
<span id="cb58-17"><a href="#cb58-17" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb58-18"><a href="#cb58-18" tabindex="-1"></a>                                  <span class="at">Gu =</span> TxDinv) <span class="sc">+</span> <span class="co">#dominance genotypic</span></span>
<span id="cb58-19"><a href="#cb58-19" tabindex="-1"></a>                       <span class="fu">vsc</span>(<span class="fu">isc</span>(Stage1Error,</span>
<span id="cb58-20"><a href="#cb58-20" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),<span class="co">#1 instead of Variance_scaled</span></span>
<span id="cb58-21"><a href="#cb58-21" tabindex="-1"></a>                                    <span class="co">#because in EEVinv we already used the scaled</span></span>
<span id="cb58-22"><a href="#cb58-22" tabindex="-1"></a>                                    <span class="co">#variance and covariance values</span></span>
<span id="cb58-23"><a href="#cb58-23" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb58-24"><a href="#cb58-24" tabindex="-1"></a>                                  <span class="at">Gu =</span> EEVinv), <span class="co">#Stage1Error</span></span>
<span id="cb58-25"><a href="#cb58-25" tabindex="-1"></a>                     <span class="at">rcov=</span><span class="sc">~</span><span class="fu">vsc</span>(<span class="fu">isc</span>(units,</span>
<span id="cb58-26"><a href="#cb58-26" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),<span class="co">#1 instead of Variance_scaled</span></span>
<span id="cb58-27"><a href="#cb58-27" tabindex="-1"></a>                                    <span class="co">#because in Rinv we already used the scaled</span></span>
<span id="cb58-28"><a href="#cb58-28" tabindex="-1"></a>                                    <span class="co">#variance and covariance values</span></span>
<span id="cb58-29"><a href="#cb58-29" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb58-30"><a href="#cb58-30" tabindex="-1"></a>                                  <span class="at">Gu =</span> Rinv), <span class="co">#residuals.</span></span>
<span id="cb58-31"><a href="#cb58-31" tabindex="-1"></a>                     <span class="at">data=</span> sommerdf_long,</span>
<span id="cb58-32"><a href="#cb58-32" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-33"><a href="#cb58-33" tabindex="-1"></a>                     <span class="at">nIters=</span><span class="dv">1</span> <span class="co">#as we already know the variances, a single</span></span>
<span id="cb58-34"><a href="#cb58-34" tabindex="-1"></a>                    <span class="co">#REML iteration is enough</span></span>
<span id="cb58-35"><a href="#cb58-35" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.Adding additional levels of Gu in the model matrix of &#39;TraitId&#39; 
## Adding additional levels of Gu in the model matrix of &#39;TraitId&#39; 
## Adding additional levels of Gu in the model matrix of &#39;Stage1Error&#39; 
## iteration    LogLik     wall    cpu(sec)   restrained
##     1      -924.746   15:36:54      173           0</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co">#Get shorter names</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a><span class="fu">names</span>(ans2mask<span class="sc">$</span>uList) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Additive&quot;</span>, <span class="st">&quot;Dominance&quot;</span>, <span class="st">&quot;Stage1Error&quot;</span>)</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a>SommerBLUPs.yield<span class="ot">&lt;-</span>ans2mask<span class="sc">$</span>uList<span class="sc">$</span>Additive[<span class="fu">grep</span>(<span class="st">&quot;total.yield&quot;</span>,</span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a>                                                <span class="fu">rownames</span>(ans2mask<span class="sc">$</span>uList<span class="sc">$</span>Additive))]</span>
<span id="cb60-6"><a href="#cb60-6" tabindex="-1"></a><span class="fu">names</span>(SommerBLUPs.yield) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(ans2mask<span class="sc">$</span>uList<span class="sc">$</span>Additive)[<span class="fu">grep</span>(<span class="st">&quot;total.yield&quot;</span>,</span>
<span id="cb60-7"><a href="#cb60-7" tabindex="-1"></a>                                                <span class="fu">rownames</span>(ans2mask<span class="sc">$</span>uList<span class="sc">$</span>Additive))]</span>
<span id="cb60-8"><a href="#cb60-8" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" tabindex="-1"></a><span class="co">#StageWise</span></span>
<span id="cb60-11"><a href="#cb60-11" tabindex="-1"></a>prep2 <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(ans1<span class="sc">$</span>blues, <span class="at">vcov=</span>ans1<span class="sc">$</span>vcov,</span>
<span id="cb60-12"><a href="#cb60-12" tabindex="-1"></a>                   <span class="at">geno=</span>geno,<span class="at">vars=</span>ans2<span class="sc">$</span>vars, </span>
<span id="cb60-13"><a href="#cb60-13" tabindex="-1"></a>                   <span class="at">mask=</span><span class="fu">data.frame</span>(<span class="at">trait=</span><span class="st">&quot;total.yield&quot;</span>))</span>
<span id="cb60-14"><a href="#cb60-14" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" tabindex="-1"></a><span class="co">#Retrieve BLUPs for total.yield trait only:</span></span>
<span id="cb60-17"><a href="#cb60-17" tabindex="-1"></a>index1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">total.yield=</span><span class="dv">1</span>, <span class="at">vine.maturity=</span><span class="dv">0</span>)</span>
<span id="cb60-18"><a href="#cb60-18" tabindex="-1"></a>ASRemlBLUPs.yield1 <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep2, geno, <span class="at">what=</span><span class="st">&quot;AV&quot;</span>, <span class="at">index.coeff=</span>index1)</span>
<span id="cb60-19"><a href="#cb60-19" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" tabindex="-1"></a><span class="co">#BLUPs</span></span>
<span id="cb60-22"><a href="#cb60-22" tabindex="-1"></a><span class="co">#High correlation</span></span>
<span id="cb60-23"><a href="#cb60-23" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.yield1<span class="sc">$</span>value, <span class="co">#StageWise, masked</span></span>
<span id="cb60-24"><a href="#cb60-24" tabindex="-1"></a>SommerBLUPs.yield[<span class="fu">match</span>(<span class="fu">paste0</span>(<span class="st">&quot;BLUEs.total.yield:&quot;</span>,ASRemlBLUPs.yield1<span class="sc">$</span>id)</span>
<span id="cb60-25"><a href="#cb60-25" tabindex="-1"></a>                        ,<span class="fu">names</span>(SommerBLUPs.yield))]) <span class="co">#Sommer, masked</span></span></code></pre></div>
<pre><code>## [1] 0.9396018</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.yield<span class="sc">$</span>value, <span class="co">#StageWise, not masked</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a>SommerBLUPs.yield[<span class="fu">match</span>(<span class="fu">paste0</span>(<span class="st">&quot;BLUEs.total.yield:&quot;</span>,ASRemlBLUPs.yield<span class="sc">$</span>id)</span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>                        ,<span class="fu">names</span>(SommerBLUPs.yield))]) <span class="co">#sommer, masked</span></span></code></pre></div>
<pre><code>## [1] 0.4706003</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.yield<span class="sc">$</span>value, <span class="co">#StageWise, not masked</span></span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>    ASRemlBLUPs.yield1<span class="sc">$</span>value) <span class="co">#StageWise, masked</span></span></code></pre></div>
<pre><code>## [1] 0.4968148</code></pre>
</div>
<div id="index-selection" class="section level3">
<h3>Index Selection</h3>
<p>One problem in multi-trait modelling is selecting the best genotypes
based on the Genomic Estimated Breeding Values (GEBVs) for the multiple
traits. Index selection is a powerful approach to solve this issue. In
index selection, the GEBVs for the different traits are merged into a
single value (index score) by performing a weighted sum of them. To
compute the weights, the breeder has to determine the relative
importance of the traits. It is also possible to set constraints to
these traits, such as forcing them to be below or above a threshold.
Taking all of this into account, it is possible to calculate the best
weights or coefficients for the index selection using convex
optimization (more on that later). StageWise does can do this
automatically with the <code>gain</code> function, but we will also show
how to do it step by step. In summary, the objectives of index selection
are twofold:</p>
<p><strong>1) Determination of the Response</strong>: The genotype with
the best combination of traits can is called the Response. The first
step in multi-trait index selection is determining the Response
according to the economical importance of the different traits,
practical constraints, etc.</p>
<p><strong>2) Calculation of Index Scores</strong>: The goal is to
compute an evaluation metric (index score) for each genotype by creating
a weighted sum of the available GEBVs of the different traits. To
achieve this, we need to determine the weights or coefficients (referred
to as indexes) that best align with the previously defined optimal
Response, i.e. we want to find a set of coefficients that allow us to
compute index scores that present the highest values for genotypes with
a performance near the Response.</p>
<p>Going back to our example, if the objective of breeding is maximizing
yield, we could simply maximize it while disregarding maturity. This
could be done with an index selection in which yield has a weight of 1
and maturity has a weight of zero (i.e., it does not influence the index
score):</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>index1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">total.yield=</span><span class="dv">1</span>, <span class="at">vine.maturity=</span><span class="dv">0</span>)</span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>GEBV1 <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep1, geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>, <span class="at">index.coeff=</span>index1)</span></code></pre></div>
<p>However, because yield and late maturity are correlated, the above
index will lead to later maturity, which is undesirable. The
<code>gain</code> command can be used to compute the expected response
for different indices, in units of intensity x standard deviation (<span class="math inline">\(i\sigma\)</span>). Its input is the output from
<code>blup_prep</code>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>gain1 <span class="ot">&lt;-</span> <span class="fu">gain</span>(<span class="at">input=</span>prep1, <span class="at">traits=</span><span class="fu">c</span>(<span class="st">&quot;total.yield&quot;</span>,<span class="st">&quot;vine.maturity&quot;</span>), </span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>              <span class="at">coeff=</span>index1)</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a><span class="co">#values of yield and maturyti expected for the best genotype according to the</span></span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a><span class="co">#selection index we have defined (i.e., just maximize yield and disregard maturity)</span></span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>gain1<span class="sc">$</span>table <span class="co">#high maturity, undesired</span></span></code></pre></div>
<pre><code>##           trait response index
## 1   total.yield    0.686     1
## 2 vine.maturity    0.414     0</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>gain1<span class="sc">$</span>plot <span class="co">#yield and maturity are correlated!</span></span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a><span class="co">#Sommer. Similar shape to gain plot</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> SommerBVs.yield,</span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>     <span class="at">y =</span> SommerBVs.maturity,</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;total.yield&quot;</span>,</span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;vine.maturity&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>bestID <span class="ot">&lt;-</span> <span class="fu">which.max</span>(SommerBVs.yield)</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a><span class="co">#High yield implies late maturity:</span></span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a>SommerBVs.yield[bestID]<span class="sc">/</span><span class="fu">sd</span>(SommerBVs.yield) <span class="co">#divide by sd to normalize</span></span></code></pre></div>
<pre><code>##  NC472-1 
## 3.245524</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a>SommerBVs.maturity[bestID]<span class="sc">/</span><span class="fu">sd</span>(SommerBVs.maturity) <span class="co">#divide by sd to normalize</span></span></code></pre></div>
<pre><code>##  NC472-1 
## 2.333962</code></pre>
<p>The plot above illustrates the ellipse of possible responses for the
two traits (in units of <span class="math inline">\(i\sigma\)</span>).
The dashed red line signifies the direction of the index vector, where
we specified zero weight for maturity. The blue line segment represents
the response that maximizes genetic merit, which, in this instance,
corresponds to the point on the ellipse with the highest yield value.
However, both the table and figure reveal that this choice results in an
increase in maturity by 0.41<span class="math inline">\(i\sigma\)</span>.</p>
<p>To select for higher yield without increasing maturity, a
<em>restricted</em> index is required. Intuitively, this involves
assigning a negative weight to maturity in the index. The optimal index
coefficient can be determined using <code>gain</code>, which requires a
table of constraints with two columns: “trait” and “sign”. For each
trait, the “sign” column can have one of three symbols: “=”, “&lt;”, or
“&gt;”, indicating whether the response should be <span class="math inline">\(= 0\)</span>, <span class="math inline">\(\leq
0\)</span>, or <span class="math inline">\(\geq 0\)</span>,
respectively. In this case, we aim for the maturity response to be less
than or equal to zero.</p>
<p>While the <code>gain</code> function is very convenient, we believe
it is important to replicate it to showcase how it works and provide
some understanding of what is happening in the background. To that end,
we will discuss two approaches for maximizing yield while enforcing a
constraint on negative maturity:</p>
<p><strong>1) Simplistic Approach</strong> 1) Enforce constraints:
Retain only BLUPs with negative maturity. 2) Among non-late maturity
genotypes, identify the one with the highest yield, and the BLUPs for
that genotype form the response vector (<span class="math inline">\(\boldsymbol{r}\)</span>). 3) Compute coefficients
(<span class="math inline">\(\boldsymbol{c}\)</span>) for calculating
index scores: <span class="math inline">\(\boldsymbol{c_0} =
\Sigma_a^{-1}\boldsymbol{r}\)</span>; <span class="math inline">\(\boldsymbol{c}
=     \frac{\boldsymbol{c_0}}{\sqrt{sum(\boldsymbol{c_0}^2)}}\)</span>,
where <span class="math inline">\(\Sigma_a\)</span> represents the trait
variance-covariance for additive effects. 4) Index Scores can be
obtained as the weighted sum of BLUPs for each trait using coefficients
<span class="math inline">\(\boldsymbol{c}\)</span> as weights.</p>
<p><strong>2) Convex Optimization Approach</strong> While the above
approach is straightforward, it relies on existing BLUPs, which are
limited in resolution as they represent a sample from the
model-estimated distribution <span class="math inline">\(\boldsymbol{a}
\sim N(0, \mathbf{G} \otimes \boldsymbol\Sigma_a)\)</span>. Furthermore,
due to shrinkage, they have a lower variance than the true breeding
values, which can be problematic when defining the exact value of
thresholds such as the maximum desired value for maturity. There is an
alternative approach that is based on the distribution of the true
breeding values and exploring the relationship across traits, i.e.,
<span class="math inline">\(N(0, \boldsymbol\Sigma_a)\)</span>. To
achieve this, we employ <strong>convex optimization</strong>, which is
what the <code>gain</code> function uses in the background. Convex
optimization is very well suited to this problem because it can very
efficiently find the optimal index scores given an objective (maximize
yield) and one or more constraints (negative maturity).</p>
<p>To fully understand the convex optimization performed here, we need
to explain the <strong>quadratic form</strong>. First, we need to define
a vector of unknown variables <span class="math inline">\(\boldsymbol{x}\)</span>, which will be the
Response. In other words, <span class="math inline">\(\boldsymbol{x} =
(x_{yield}, x_{maturity})\)</span> are the expected values for both
traits in the best genotype. The inverse of the variance-covariance
matrix for trait BLUPs, <span class="math inline">\(\Sigma_a^{-1}\)</span>, plays a pivotal role in
the quadratic form, yielding <span class="math inline">\(\text{quad_form}(\boldsymbol{x},\Sigma_a^{-1}) =
\boldsymbol{x}^\top \Sigma_a^{-1}\boldsymbol{x}\)</span>. This form
generates a polynomial with all elements of order 2. Plotting the
equation <span class="math inline">\(t(\boldsymbol{x})\Sigma_a^{-1}\boldsymbol{x} =
\text{cutoff}\)</span> results in an ellipse, representing a
cross-section of the multivariate normal distribution <span class="math inline">\(N(0, \boldsymbol\Sigma_a)\)</span> followed by the
breeding values. If you are interested in knowing where this equation
comes from, <span class="math inline">\(t(\boldsymbol{x})\Sigma_a^{-1}\boldsymbol{x} =
\text{cutoff}\)</span> is the probability density function of the
elliptical distribution associated to <span class="math inline">\(N(0,
\boldsymbol\Sigma_a)\)</span> (for more details, see section 1.2.1 of
Frahm, G. (2004)). Different values of “cutoff” determine the size of
the plotted ellipse, with larger values yielding larger ellipses.</p>
<p>A common desired cutoff value is the one that ensures that the
ellipse encompasses 95% of the probability density, which can be
determined using the <code>qchisq()</code> function. It is important to
note that the cutoff value won’t affect optimization results, but it
will impact ellipse visualization. In other words, it will alter the
absolute value of the Response but not their relative values.</p>
<p>By employing the quadratic form, we can conduct convex optimization
within the ellipse, i.e. we are informing the optimization process of
the existing correlation between traits. This is essential for
restricting the search to reasonable values for yield and maturity. The
convex optimization problem can be defined with several constraints (in
this case negative maturity values and all values must be within the
ellipse defined by the quadratic form and cutoff) and an objective
(maximizing yield). Solving this problem using the “CVXR” package allows
us to identify the optimal response. Subsequently, the coefficients for
index selection can be easily obtained as <span class="math inline">\(\boldsymbol{c} =
\Sigma_a^{-1}\boldsymbol{x}\)</span>. To understand why, we first need
to keep in mind that the desired vector of coefficients <span class="math inline">\(\boldsymbol{c}\)</span> is the one that, when
applied to the genotypic values (samples from <span class="math inline">\(N(0, \boldsymbol\Sigma_a)\)</span>), results in a
selection index with high values near the response <span class="math inline">\(\boldsymbol{x}\)</span>. Next, the equation is
much intuitive if we move the covariance matrix to its left side: <span class="math inline">\(\Sigma_a\boldsymbol{c} = \boldsymbol{x}\)</span>.
The covariance matrix <span class="math inline">\(\Sigma_a\)</span> has
a direction in which it has maximum variance (eigenvector of the first
principal component). Similarly, the vector <span class="math inline">\(c\)</span> is pointing to another direction.
Geometrically, multiplying <span class="math inline">\(\Sigma_a\boldsymbol{c}\)</span> results in a new
vector with a direction in between <span class="math inline">\(c\)</span> and the direction of maximum variance
in <span class="math inline">\(\Sigma_a\)</span>. Thus, it can be said
that when we apply <span class="math inline">\(\Sigma_a\)</span> to
<span class="math inline">\(\boldsymbol{c}\)</span>, we are turning the
latter towards the maximum variance of the former. Conversely, it can be
said that applying <span class="math inline">\(\boldsymbol{c}\)</span>
to <span class="math inline">\(\Sigma_a\)</span> turns the direction of
maximum variance of <span class="math inline">\(\Sigma_a\)</span>
towards <span class="math inline">\(c\)</span>. Knowing this, we need to
find a vector of coefficients <span class="math inline">\(c\)</span>
such that, when applied to <span class="math inline">\(\Sigma_a\)</span>, it turns its direction of
maximum variance to point towards the response vector <span class="math inline">\(\boldsymbol{x}\)</span>. This would result in a
selection index that has its maximum variance in the direction of the
response, i.e. it has larger values for genotypes close to the optimal
one (the response). This is exactly what we need. The easy way to find
this desired vector of coefficients is solving the equation: <span class="math inline">\(\Sigma_a\boldsymbol{c} = \boldsymbol{x};
\boldsymbol{c} = \Sigma_a^{-1}\boldsymbol{x}\)</span>, which is the
equation we described initially.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="co">#StageWise</span></span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a><span class="co">#Gain function uses convex optimization</span></span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>gain2 <span class="ot">&lt;-</span> <span class="fu">gain</span>(<span class="at">input=</span>prep1, <span class="at">traits=</span><span class="fu">c</span>(<span class="st">&quot;total.yield&quot;</span>,<span class="st">&quot;vine.maturity&quot;</span>),</span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>              <span class="at">coeff=</span>index1, <span class="co">#user-defined relative importance of the traits</span></span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a>              <span class="at">restricted=</span><span class="fu">data.frame</span>(<span class="at">trait=</span><span class="st">&quot;vine.maturity&quot;</span>, <span class="at">sign=</span><span class="st">&quot;&lt;&quot;</span>)) <span class="co">#constraits</span></span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>gain2<span class="sc">$</span>table</span></code></pre></div>
<pre><code>##           trait response  index
## 1   total.yield    0.556  0.870
## 2 vine.maturity    0.000 -0.494</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a>gain2<span class="sc">$</span>plot</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>index2 <span class="ot">&lt;-</span> gain2<span class="sc">$</span>table<span class="sc">$</span>index <span class="co">#coefficients</span></span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a><span class="fu">names</span>(index2) <span class="ot">&lt;-</span> gain2<span class="sc">$</span>table<span class="sc">$</span>trait</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>GEBV2 <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep1, geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>, <span class="at">index.coeff=</span>index2) <span class="co">#Evaluation metric</span></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a><span class="co">#that summarizes both traits. (Index Scores)</span></span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a><span class="co">#Sommer. </span></span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a><span class="co">#Similar shape to StageWise ellipse</span></span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> SommerBVs.yield, </span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a>     <span class="at">y =</span> SommerBVs.maturity,</span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;total.yield&quot;</span>,</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;vine.maturity&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="co">#Find response and coefficients from Sommer results</span></span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a><span class="co">#(Replicate the gain() function from StageWise):</span></span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a><span class="co">#1) Simplistic approach (not recommended but useful for understanding the process): </span></span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a><span class="co">#1.1) Enforce constraints: leave only negative values for maturity</span></span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a>restrictedIDs <span class="ot">&lt;-</span> <span class="fu">which</span>(SommerBVs.maturity <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>bestID <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">which.max</span>(SommerBVs.yield[restrictedIDs]))</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>bestIDindex <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(SommerBVs.yield) <span class="sc">==</span> bestID)</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a><span class="co">#1.2) Highest yield without late maturity:</span></span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a>SommerBVs.yield[bestIDindex]</span></code></pre></div>
<pre><code>## MSBB131-01 
##   10.45718</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>SommerBVs.maturity[bestIDindex]</span></code></pre></div>
<pre><code>##  MSBB131-01 
## -0.06940358</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="co">#1.3) Get the coefficients that allow us to identify the best BLUPs that respect our</span></span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a><span class="co">#constraints</span></span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">c</span>(SommerBVs.yield[bestIDindex],SommerBVs.maturity[bestIDindex])</span>
<span id="cb83-4"><a href="#cb83-4" tabindex="-1"></a>response <span class="co">#best yield and maturity values</span></span></code></pre></div>
<pre><code>##  MSBB131-01  MSBB131-01 
## 10.45718019 -0.06940358</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a>BLUPsvcovInv <span class="ot">&lt;-</span> <span class="fu">solve</span>(ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>) <span class="co">#inverse of the variance-covariance</span></span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a><span class="co">#across traits</span></span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a>c.opt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(BLUPsvcovInv <span class="sc">%*%</span> response) <span class="co">#get coefficients</span></span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a>c.opt <span class="ot">&lt;-</span> c.opt<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">sum</span>(c.opt<span class="sc">^</span><span class="dv">2</span>)) <span class="co">#normalize coefficients</span></span>
<span id="cb85-6"><a href="#cb85-6" tabindex="-1"></a><span class="co">#these coefficients allow to merge the breeding values of the two traits</span></span>
<span id="cb85-7"><a href="#cb85-7" tabindex="-1"></a><span class="co">#into a single value reflecting the desired trait relative importance and constraints</span></span>
<span id="cb85-8"><a href="#cb85-8" tabindex="-1"></a>c.opt</span></code></pre></div>
<pre><code>## [1]  0.2672984 -0.9636138</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a>WeightedBV <span class="ot">&lt;-</span> c.opt[<span class="dv">1</span>]<span class="sc">*</span>SommerBVs.yield <span class="sc">+</span> c.opt[<span class="dv">2</span>]<span class="sc">*</span>SommerBVs.maturity </span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>WeightedBV[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##  A11516-1C AC10239-7W AC11453-7W AC11494-6W  AF5033-13 
##  0.1542752 -1.3972749  0.5142730  0.8400987 -1.3489123</code></pre>
<p>The previous approach is straightforward but somewhat simplistic. To
calculate both the response and the coefficients (c.opt), we relied on
existing BLUPs. However, it’s important to note that BLUPs are merely a
sample from the distribution estimated by the model. This sampling
process limits the “resolution” of our approach. Essentially, we are
using as many data points as there are genotypes to estimate the
coefficients. Furthermore, the BLUPs are shrunk, which can cause
problems as it can cause the thresholds defined by the breeders
meaningless.</p>
<p>Alternative, we can use convex optimization, which, as described
before, is a much more robust methodology:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="co">#2) convex optimization</span></span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a><span class="co">#library(CVXR)</span></span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a><span class="co"># We will utilize the &#39;CVXR&#39; library for convex optimization.</span></span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb89-5"><a href="#cb89-5" tabindex="-1"></a>c2 <span class="ot">&lt;-</span> <span class="fu">qchisq</span>(<span class="at">p =</span> (<span class="dv">1</span><span class="sc">-</span>alpha), <span class="at">df=</span>n.trait, <span class="at">lower.tail =</span> <span class="cn">TRUE</span>) <span class="co">#cutoff resulting </span></span>
<span id="cb89-6"><a href="#cb89-6" tabindex="-1"></a><span class="co">#in an ellipse containing 1-alpha of the probability density</span></span>
<span id="cb89-7"><a href="#cb89-7" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" tabindex="-1"></a><span class="co">#Get the inverse of the variance-covariance matrix of the traits:</span></span>
<span id="cb89-9"><a href="#cb89-9" tabindex="-1"></a>BLUPsvcovInv <span class="ot">&lt;-</span> <span class="fu">solve</span>(ans2open<span class="sc">$</span>sigma<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>) </span>
<span id="cb89-10"><a href="#cb89-10" tabindex="-1"></a>    </span>
<span id="cb89-11"><a href="#cb89-11" tabindex="-1"></a><span class="co">#x: vector with the two variables (the two traits)</span></span>
<span id="cb89-12"><a href="#cb89-12" tabindex="-1"></a><span class="co">#Variable 1 = total.yield</span></span>
<span id="cb89-13"><a href="#cb89-13" tabindex="-1"></a><span class="co">#Variable 2 = vine.maturity</span></span>
<span id="cb89-14"><a href="#cb89-14" tabindex="-1"></a><span class="co">#The order of the traits is the same we used for the model</span></span>
<span id="cb89-15"><a href="#cb89-15" tabindex="-1"></a><span class="co">#Convex optimization will find the optimal values of x, i.e. the Response</span></span>
<span id="cb89-16"><a href="#cb89-16" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">Variable</span>(n.trait)</span>
<span id="cb89-17"><a href="#cb89-17" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" tabindex="-1"></a><span class="co">#First constraint: we will only scan inside the ellipse </span></span>
<span id="cb89-19"><a href="#cb89-19" tabindex="-1"></a><span class="co">#&quot;quad_form(x,BLUPsvcovInv) = cutoff&quot;</span></span>
<span id="cb89-20"><a href="#cb89-20" tabindex="-1"></a><span class="co">#i.e., during optimization we will only consider realistic values for the BLUPs</span></span>
<span id="cb89-21"><a href="#cb89-21" tabindex="-1"></a><span class="co">#of both traits, considering their correlation.</span></span>
<span id="cb89-22"><a href="#cb89-22" tabindex="-1"></a>constraints <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">quad_form</span>(x,BLUPsvcovInv) <span class="sc">&lt;=</span> c2)</span>
<span id="cb89-23"><a href="#cb89-23" tabindex="-1"></a></span>
<span id="cb89-24"><a href="#cb89-24" tabindex="-1"></a><span class="co">#Add constraint: vine.maturity smaller than 0</span></span>
<span id="cb89-25"><a href="#cb89-25" tabindex="-1"></a><span class="co">#&quot;A&quot; matrix means: </span></span>
<span id="cb89-26"><a href="#cb89-26" tabindex="-1"></a><span class="co">#Trait 1 (total.yield) --&gt; unconstrained --&gt; Set its value to 0</span></span>
<span id="cb89-27"><a href="#cb89-27" tabindex="-1"></a><span class="co">#Trait 2 (vine.maturity) --&gt; constrained --&gt; Set its value to 1</span></span>
<span id="cb89-28"><a href="#cb89-28" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb89-29"><a href="#cb89-29" tabindex="-1"></a><span class="co">#The constrained variables (only vine.maturity) must be smaller than 0</span></span>
<span id="cb89-30"><a href="#cb89-30" tabindex="-1"></a>constraints <span class="ot">&lt;-</span> <span class="fu">c</span>(constraints,<span class="fu">list</span>(A<span class="sc">%*%</span>x<span class="sc">&lt;=</span><span class="dv">0</span>))</span>
<span id="cb89-31"><a href="#cb89-31" tabindex="-1"></a></span>
<span id="cb89-32"><a href="#cb89-32" tabindex="-1"></a><span class="co">#objective of the optimization: maximize a linear combination of traits</span></span>
<span id="cb89-33"><a href="#cb89-33" tabindex="-1"></a><span class="co">#in this case, we want to maximize yield only</span></span>
<span id="cb89-34"><a href="#cb89-34" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">nrow=</span><span class="dv">1</span>) <span class="co">#1 = weight for yield, 0 = weight for maturity</span></span>
<span id="cb89-35"><a href="#cb89-35" tabindex="-1"></a>objective <span class="ot">&lt;-</span> <span class="fu">Maximize</span>(v<span class="sc">%*%</span>x)</span>
<span id="cb89-36"><a href="#cb89-36" tabindex="-1"></a></span>
<span id="cb89-37"><a href="#cb89-37" tabindex="-1"></a><span class="co">#Define optimization problem</span></span>
<span id="cb89-38"><a href="#cb89-38" tabindex="-1"></a>problem <span class="ot">&lt;-</span> <span class="fu">Problem</span>(objective,constraints)</span>
<span id="cb89-39"><a href="#cb89-39" tabindex="-1"></a></span>
<span id="cb89-40"><a href="#cb89-40" tabindex="-1"></a><span class="co">#Perform optimization</span></span>
<span id="cb89-41"><a href="#cb89-41" tabindex="-1"></a>result <span class="ot">&lt;-</span> CVXR<span class="sc">::</span><span class="fu">solve</span>(problem,<span class="at">solver=</span><span class="st">&quot;ECOS&quot;</span>)</span>
<span id="cb89-42"><a href="#cb89-42" tabindex="-1"></a></span>
<span id="cb89-43"><a href="#cb89-43" tabindex="-1"></a>x.opt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(result<span class="sc">$</span><span class="fu">getValue</span>(x)) <span class="co">#response</span></span>
<span id="cb89-44"><a href="#cb89-44" tabindex="-1"></a>c.opt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(BLUPsvcovInv <span class="sc">%*%</span> x.opt)</span>
<span id="cb89-45"><a href="#cb89-45" tabindex="-1"></a>c.opt <span class="ot">&lt;-</span> c.opt<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">sum</span>(c.opt<span class="sc">^</span><span class="dv">2</span>)) <span class="co">#coefficients</span></span>
<span id="cb89-46"><a href="#cb89-46" tabindex="-1"></a><span class="fu">names</span>(x.opt) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;total.yield&quot;</span>, <span class="st">&quot;vine.maturity&quot;</span>)</span>
<span id="cb89-47"><a href="#cb89-47" tabindex="-1"></a></span>
<span id="cb89-48"><a href="#cb89-48" tabindex="-1"></a><span class="co">#Index Scores combining both traits and reflecting desired constraints:</span></span>
<span id="cb89-49"><a href="#cb89-49" tabindex="-1"></a>WeightedBV <span class="ot">&lt;-</span> c.opt[<span class="dv">1</span>]<span class="sc">*</span>SommerBVs.yield <span class="sc">+</span> c.opt[<span class="dv">2</span>]<span class="sc">*</span>SommerBVs.maturity </span>
<span id="cb89-50"><a href="#cb89-50" tabindex="-1"></a></span>
<span id="cb89-51"><a href="#cb89-51" tabindex="-1"></a></span>
<span id="cb89-52"><a href="#cb89-52" tabindex="-1"></a><span class="co">#For plotting, we need to extract the general equation of the ellipse from the</span></span>
<span id="cb89-53"><a href="#cb89-53" tabindex="-1"></a><span class="co">#quadratic form:</span></span>
<span id="cb89-54"><a href="#cb89-54" tabindex="-1"></a></span>
<span id="cb89-55"><a href="#cb89-55" tabindex="-1"></a><span class="co">#Ellipse general equation:</span></span>
<span id="cb89-56"><a href="#cb89-56" tabindex="-1"></a><span class="co">#Ax^2 + Bxy + Cy^2 + Dx + Ey + FF = 0</span></span>
<span id="cb89-57"><a href="#cb89-57" tabindex="-1"></a></span>
<span id="cb89-58"><a href="#cb89-58" tabindex="-1"></a><span class="co">#A, B and C can be extracted from the quadratic form: </span></span>
<span id="cb89-59"><a href="#cb89-59" tabindex="-1"></a><span class="co">#matrix(c(x,y),nrow=1)%*%BLUPsvcovInv%*%t(matrix(c(x,y),nrow=1))</span></span>
<span id="cb89-60"><a href="#cb89-60" tabindex="-1"></a></span>
<span id="cb89-61"><a href="#cb89-61" tabindex="-1"></a>A <span class="ot">=</span> BLUPsvcovInv[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb89-62"><a href="#cb89-62" tabindex="-1"></a>B <span class="ot">=</span> BLUPsvcovInv[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">+</span> BLUPsvcovInv[<span class="dv">2</span>,<span class="dv">1</span>]</span>
<span id="cb89-63"><a href="#cb89-63" tabindex="-1"></a>C <span class="ot">=</span> BLUPsvcovInv[<span class="dv">2</span>,<span class="dv">2</span>]</span>
<span id="cb89-64"><a href="#cb89-64" tabindex="-1"></a>D <span class="ot">=</span> <span class="dv">0</span> <span class="co">#centered at mean = 0 for total.yield</span></span>
<span id="cb89-65"><a href="#cb89-65" tabindex="-1"></a>E <span class="ot">=</span> <span class="dv">0</span> <span class="co">#centered at mean = 0 for vine.maturity</span></span>
<span id="cb89-66"><a href="#cb89-66" tabindex="-1"></a>FF <span class="ot">=</span> <span class="sc">-</span>c2 <span class="co">#minus cutoff (we want it to be positive if we move it to the other</span></span>
<span id="cb89-67"><a href="#cb89-67" tabindex="-1"></a><span class="co">#side of the equation)</span></span>
<span id="cb89-68"><a href="#cb89-68" tabindex="-1"></a></span>
<span id="cb89-69"><a href="#cb89-69" tabindex="-1"></a></span>
<span id="cb89-70"><a href="#cb89-70" tabindex="-1"></a><span class="co">#Transform the general equation to the canonical form for plotting:</span></span>
<span id="cb89-71"><a href="#cb89-71" tabindex="-1"></a>a <span class="ot">=</span> <span class="sc">-</span><span class="fu">sqrt</span>(<span class="dv">2</span><span class="sc">*</span>(A<span class="sc">*</span>E<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>C<span class="sc">*</span>D<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>B<span class="sc">*</span>D<span class="sc">*</span>E<span class="sc">+</span>(B<span class="sc">^</span><span class="dv">2-4</span><span class="sc">*</span>A<span class="sc">*</span>C)<span class="sc">*</span>FF)<span class="sc">*</span>((A<span class="sc">+</span>C) <span class="sc">-</span> <span class="fu">sqrt</span>((A<span class="sc">-</span>C)<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>B<span class="sc">^</span><span class="dv">2</span>)))<span class="sc">/</span>(B<span class="sc">^</span><span class="dv">2-4</span><span class="sc">*</span>A<span class="sc">*</span>C)</span>
<span id="cb89-72"><a href="#cb89-72" tabindex="-1"></a>b <span class="ot">=</span> <span class="sc">-</span><span class="fu">sqrt</span>(<span class="dv">2</span><span class="sc">*</span>(A<span class="sc">*</span>E<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>C<span class="sc">*</span>D<span class="sc">^</span><span class="dv">2</span><span class="sc">-</span>B<span class="sc">*</span>D<span class="sc">*</span>E<span class="sc">+</span>(B<span class="sc">^</span><span class="dv">2-4</span><span class="sc">*</span>A<span class="sc">*</span>C)<span class="sc">*</span>FF)<span class="sc">*</span>((A<span class="sc">+</span>C) <span class="sc">+</span> <span class="fu">sqrt</span>((A<span class="sc">-</span>C)<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>B<span class="sc">^</span><span class="dv">2</span>)))<span class="sc">/</span>(B<span class="sc">^</span><span class="dv">2-4</span><span class="sc">*</span>A<span class="sc">*</span>C)</span>
<span id="cb89-73"><a href="#cb89-73" tabindex="-1"></a>theta <span class="ot">&lt;-</span> pi<span class="sc">/</span><span class="dv">2</span><span class="sc">-</span><span class="fu">atan</span>((C<span class="sc">-</span>A<span class="sc">-</span><span class="fu">sqrt</span>((A<span class="sc">-</span>C)<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>B<span class="sc">^</span><span class="dv">2</span>))<span class="sc">/</span>B)</span>
<span id="cb89-74"><a href="#cb89-74" tabindex="-1"></a></span>
<span id="cb89-75"><a href="#cb89-75" tabindex="-1"></a><span class="co">#Dataframe for plotting: contains the BLUPs for both traits</span></span>
<span id="cb89-76"><a href="#cb89-76" tabindex="-1"></a>plotdf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">total.yield=</span>SommerBVs.yield,</span>
<span id="cb89-77"><a href="#cb89-77" tabindex="-1"></a>                             <span class="at">vine.maturity=</span>SommerBVs.maturity,</span>
<span id="cb89-78"><a href="#cb89-78" tabindex="-1"></a>                             <span class="at">Index_scores =</span> WeightedBV, <span class="co">#Index Scores</span></span>
<span id="cb89-79"><a href="#cb89-79" tabindex="-1"></a>                             <span class="at">best10 =</span> F)</span>
<span id="cb89-80"><a href="#cb89-80" tabindex="-1"></a></span>
<span id="cb89-81"><a href="#cb89-81" tabindex="-1"></a><span class="co">#Highlight the 10 best genotypes according to the Index Scores summarizing</span></span>
<span id="cb89-82"><a href="#cb89-82" tabindex="-1"></a><span class="co">#both traits, which in turn depends on the coefficients calculated during optimization.</span></span>
<span id="cb89-83"><a href="#cb89-83" tabindex="-1"></a>best10 <span class="ot">&lt;-</span> <span class="fu">order</span>(plotdf<span class="sc">$</span>Index_scores, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb89-84"><a href="#cb89-84" tabindex="-1"></a>plotdf<span class="sc">$</span>best10[best10] <span class="ot">&lt;-</span> T </span>
<span id="cb89-85"><a href="#cb89-85" tabindex="-1"></a></span>
<span id="cb89-86"><a href="#cb89-86" tabindex="-1"></a></span>
<span id="cb89-87"><a href="#cb89-87" tabindex="-1"></a><span class="co">#Plot Sommer GEBVs</span></span>
<span id="cb89-88"><a href="#cb89-88" tabindex="-1"></a><span class="fu">ggplot</span>()  <span class="sc">+</span> </span>
<span id="cb89-89"><a href="#cb89-89" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> plotdf,</span>
<span id="cb89-90"><a href="#cb89-90" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">x=</span>total.yield, <span class="at">y=</span>vine.maturity, <span class="at">color =</span> Index_scores)) <span class="sc">+</span> </span>
<span id="cb89-91"><a href="#cb89-91" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> plotdf[best10,],</span>
<span id="cb89-92"><a href="#cb89-92" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">x=</span>total.yield, <span class="at">y=</span>vine.maturity), <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb89-93"><a href="#cb89-93" tabindex="-1"></a>  <span class="fu">geom_ellipse</span>(<span class="fu">aes</span>(<span class="at">x0=</span><span class="dv">0</span>,<span class="at">y0=</span><span class="dv">0</span>, <span class="at">a=</span>a, <span class="at">b=</span>b, <span class="at">angle =</span> <span class="sc">-</span>theta)) <span class="sc">+</span></span>
<span id="cb89-94"><a href="#cb89-94" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Sommer&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a><span class="co">#Repeat the same plot using the StageWise GEBVs and the coefficients obtained</span></span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a><span class="co">#using gain() function from StageWise</span></span>
<span id="cb90-3"><a href="#cb90-3" tabindex="-1"></a>GEBV2ordered <span class="ot">&lt;-</span> GEBV2[<span class="fu">match</span>(<span class="fu">rownames</span>(plotdf), GEBV2<span class="sc">$</span>id),]</span>
<span id="cb90-4"><a href="#cb90-4" tabindex="-1"></a>plotdf<span class="sc">$</span>Index_scores <span class="ot">&lt;-</span> GEBV2ordered<span class="sc">$</span>value <span class="co">#Index Scores</span></span>
<span id="cb90-5"><a href="#cb90-5" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" tabindex="-1"></a>best10ASReml <span class="ot">&lt;-</span> <span class="fu">order</span>(plotdf<span class="sc">$</span>Index_scores, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb90-7"><a href="#cb90-7" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" tabindex="-1"></a><span class="co">#Plot StageWise BLUPs</span></span>
<span id="cb90-9"><a href="#cb90-9" tabindex="-1"></a><span class="fu">ggplot</span>()  <span class="sc">+</span> </span>
<span id="cb90-10"><a href="#cb90-10" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data =</span> plotdf,</span>
<span id="cb90-11"><a href="#cb90-11" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">x=</span>total.yield, <span class="at">y=</span>vine.maturity, <span class="at">color =</span> Index_scores)) <span class="sc">+</span> </span>
<span id="cb90-12"><a href="#cb90-12" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> plotdf[best10ASReml,],</span>
<span id="cb90-13"><a href="#cb90-13" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">x=</span>total.yield, <span class="at">y=</span>vine.maturity), <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb90-14"><a href="#cb90-14" tabindex="-1"></a>  <span class="fu">geom_ellipse</span>(<span class="fu">aes</span>(<span class="at">x0=</span><span class="dv">0</span>,<span class="at">y0=</span><span class="dv">0</span>, <span class="at">a=</span>a, <span class="at">b=</span>b, <span class="at">angle =</span> <span class="sc">-</span>theta))  <span class="sc">+</span></span>
<span id="cb90-15"><a href="#cb90-15" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;StageWise&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<p>The table output shows the index coefficients to achieve zero
response for maturity while maximizing yield, while the ellipse allows
to visualize it.</p>
<p>We can use this information to calculate breeding values for the
selection index:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a><span class="co">#The Index Scores summarizing both traits are very similar for StageWise and Sommer:</span></span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a><span class="fu">cor</span>(GEBV2<span class="sc">$</span>value, <span class="co">#StageWise</span></span>
<span id="cb91-3"><a href="#cb91-3" tabindex="-1"></a>WeightedBV[<span class="fu">match</span>(GEBV2<span class="sc">$</span>id,<span class="fu">names</span>(WeightedBV))]) <span class="co">#Sommer</span></span></code></pre></div>
<pre><code>## [1] 0.9770121</code></pre>
<p>The following code helps visualize how the ranking of genotypes is
different with the restricted index compared to maximizing yield
alone.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="co"># Rank genotypes from high to low </span></span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>GEBV1<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">rank</span>(<span class="sc">-</span>GEBV1<span class="sc">$</span>value)</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a>GEBV2<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">rank</span>(<span class="sc">-</span>GEBV2<span class="sc">$</span>value)</span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a>seg1 <span class="ot">&lt;-</span> <span class="fu">merge</span>(GEBV1[,<span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;y&quot;</span>)],GEBV2[,<span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;y&quot;</span>)],<span class="at">by=</span><span class="st">&quot;id&quot;</span>)</span>
<span id="cb93-6"><a href="#cb93-6" tabindex="-1"></a><span class="fu">colnames</span>(seg1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;yend&quot;</span>)</span>
<span id="cb93-7"><a href="#cb93-7" tabindex="-1"></a>plot.data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(seg1[seg1<span class="sc">$</span>y <span class="sc">&lt;=</span> <span class="dv">10</span> <span class="sc">|</span> seg1<span class="sc">$</span>yend <span class="sc">&lt;=</span> <span class="dv">10</span>,],<span class="at">x=</span><span class="dv">0</span>,<span class="at">xend=</span><span class="dv">1</span>)</span>
<span id="cb93-8"><a href="#cb93-8" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" tabindex="-1"></a><span class="fu">ggplot</span>(plot.data,<span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">xend=</span>xend,<span class="at">yend=</span>yend)) <span class="sc">+</span> <span class="fu">geom_segment</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb93-11"><a href="#cb93-11" tabindex="-1"></a>  <span class="fu">scale_y_reverse</span>(<span class="at">lim=</span><span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">0</span>),<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),<span class="at">minor_breaks =</span> <span class="cn">NULL</span>,<span class="at">name=</span><span class="st">&quot;Rank&quot;</span>,</span>
<span id="cb93-12"><a href="#cb93-12" tabindex="-1"></a>                  <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans=</span><span class="sc">~</span>.<span class="sc">*</span><span class="dv">1</span>,<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>))) <span class="sc">+</span></span>
<span id="cb93-13"><a href="#cb93-13" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;unrestricted&quot;</span>,<span class="st">&quot;restricted&quot;</span>),<span class="at">name=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-14"><a href="#cb93-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>),<span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">13</span>))</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<p>Now that we have GEBV for yield and maturity, we can incorporate fry
color into the index with equal weight as yield. This is achieved by
supplying a list of class “prep” objects (generated from
<code>blup_prep</code>) to the <code>blup</code> command. The first
object corresponds to yield and maturity, and the second object
corresponds to fry color. It’s essential to use the same genetic model
(including dominance) for all traits when combining them in the
index.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a>fry1 <span class="ot">&lt;-</span> <span class="fu">Stage1</span>(<span class="at">filename=</span>pheno.file,<span class="at">traits=</span><span class="st">&quot;fry.color&quot;</span>,</span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a>              <span class="at">effects=</span>effects)</span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a>fry2 <span class="ot">&lt;-</span> <span class="fu">Stage2</span>(<span class="at">data=</span>fry1<span class="sc">$</span>blues, <span class="at">vcov=</span>fry1<span class="sc">$</span>vcov, <span class="at">geno=</span>geno, <span class="at">non.add=</span><span class="st">&quot;dom&quot;</span>)</span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a>fry.prep <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(fry1<span class="sc">$</span>blues, fry1<span class="sc">$</span>vcov, geno, fry2<span class="sc">$</span>vars)</span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a>index3 <span class="ot">&lt;-</span> <span class="fu">c</span>(index2, <span class="at">fry.color=</span><span class="fu">as.numeric</span>(index2[<span class="st">&quot;total.yield&quot;</span>]))</span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a>index3</span></code></pre></div>
<pre><code>##   total.yield vine.maturity     fry.color 
##         0.870        -0.494         0.870</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a>GEBV3 <span class="ot">&lt;-</span> <span class="fu">blup</span>(<span class="at">data=</span><span class="fu">list</span>(prep1,<span class="at">fry.color=</span>fry.prep), <span class="at">geno=</span>geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>,</span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a>              <span class="at">index.coeff=</span>index3)</span></code></pre></div>
</div>
<div id="genomic-prediction-with-secondary-traits" class="section level3">
<h3>Genomic prediction with secondary traits</h3>
<p>The “mask” argument in <code>blup_prep</code> facilitates the
exploration of the potential benefits of using a correlated secondary
trait to enhance genomic selection. For instance, many plant breeding
programs are currently investigating the integration of spectral
measurements obtained from high-throughput phenotyping platforms to
enhance yield selection. In this context, we can refer to the example
based on data from Rutkoski et al. (2016), who demonstrated that canopy
temperature (CT) during grain fill could predict yield in wheat.</p>
<p>Both the G matrix and Stage 1 Best Linear Unbiased Estimates (BLUEs)
from drought and extreme drought environments are distributed with the
package. Similar to the potato dataset discussed in Vignette 1,
including the Stage 1 errors in Stage 2 substantially reduces the Akaike
Information Criterion (AIC).</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a><span class="fu">data</span>(wheat, <span class="at">package =</span> <span class="fu">c</span>(<span class="st">&quot;StageWise&quot;</span>)) <span class="co">#load the wheat data</span></span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a><span class="fu">head</span>(wheat.blues)</span></code></pre></div>
<pre><code>##       env      id trait      BLUE
## 1 drought 6569128    GY  3.395834
## 2 drought 6569128    CT 36.950000
## 3 drought 6688880    GY  3.494048
## 4 drought 6688880    CT 37.902333
## 5 drought 6688916    GY  3.459078
## 6 drought 6688916    CT 38.706000</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a>wheat.EEV <span class="ot">&lt;-</span> wheat.vcov <span class="co">#StageWise calls EEV &quot;vcov&quot;</span></span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a>ans2a <span class="ot">&lt;-</span> <span class="fu">Stage2</span>(<span class="at">data=</span>wheat.blues, <span class="at">vcov=</span>wheat.EEV, <span class="at">geno=</span>wheat.geno,</span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a>                <span class="at">non.add=</span><span class="st">&quot;none&quot;</span>)</span>
<span id="cb99-5"><a href="#cb99-5" tabindex="-1"></a>ans2b <span class="ot">&lt;-</span> <span class="fu">Stage2</span>(<span class="at">data=</span>wheat.blues, <span class="at">geno=</span>wheat.geno, <span class="at">non.add=</span><span class="st">&quot;none&quot;</span>)</span>
<span id="cb99-6"><a href="#cb99-6" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">vcov=</span><span class="fu">c</span>(<span class="cn">TRUE</span>,<span class="cn">FALSE</span>), <span class="at">AIC=</span><span class="fu">c</span>(ans2a<span class="sc">$</span>aic,ans2b<span class="sc">$</span>aic))</span></code></pre></div>
<pre><code>##    vcov       AIC
## 1  TRUE -16.97154
## 2 FALSE 539.30801</code></pre>
<p>Because the wheat lines are inbred, the genetic residual option in
StageWise would be appropriate for modeling non-additive values, but
this led to convergence problems with ASReml-R. Thus, non-additive
effects were omitted using the argument non.add=“none”. Genomic
heritability was 0.45-0.50 for yield and canopy temperature, with an
additive genetic correlation of -0.81.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a><span class="fu">summary</span>(ans2a<span class="sc">$</span>vars)</span></code></pre></div>
<pre><code>## $var
##                 GY   CT
## env          0.621 1.58
## additive     0.101 0.61
## g x env      0.048 0.44
## Stage1.error 0.055 0.30
## 
## $PVE
##                 GY    CT
## additive     0.495 0.454
## g x env      0.237 0.326
## Stage1.error 0.269 0.221
## 
## $cor.mat
##        GY     CT
## GY  1.000 -0.807
## CT -0.807  1.000</code></pre>
<p>Moving on to genomic predictions, our initial step involves
conducting a tenfold cross-validation without the use of CT data for the
selection candidates. This approach can be referred to as marker-based
selection (MBS,), as outlined in Vignette 1. Given that our primary
objective is yield prediction, the index coefficients are set to 1 for
GY and 0 for CT.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a>id <span class="ot">&lt;-</span> <span class="fu">unique</span>(wheat.blues<span class="sc">$</span>id)</span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(id)</span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">split</span>(<span class="fu">sample</span>(id),<span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span>N,<span class="dv">10</span>))</span>
<span id="cb103-4"><a href="#cb103-4" tabindex="-1"></a>MBS <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb103-5"><a href="#cb103-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb103-6"><a href="#cb103-6" tabindex="-1"></a>  prep <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(wheat.blues, wheat.EEV, wheat.geno, ans2a<span class="sc">$</span>vars, </span>
<span id="cb103-7"><a href="#cb103-7" tabindex="-1"></a>                    <span class="at">mask=</span><span class="fu">data.frame</span>(<span class="at">id=</span>folds[[i]]))</span>
<span id="cb103-8"><a href="#cb103-8" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep, <span class="at">geno=</span>wheat.geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>, </span>
<span id="cb103-9"><a href="#cb103-9" tabindex="-1"></a>               <span class="at">index.coeff=</span><span class="fu">c</span>(<span class="at">GY=</span><span class="dv">1</span>, <span class="at">CT=</span><span class="dv">0</span>))</span>
<span id="cb103-10"><a href="#cb103-10" tabindex="-1"></a>  MBS <span class="ot">&lt;-</span> <span class="fu">rbind</span>(MBS, pred[pred<span class="sc">$</span>id <span class="sc">%in%</span> folds[[i]],])</span>
<span id="cb103-11"><a href="#cb103-11" tabindex="-1"></a>}</span></code></pre></div>
<p>In the code provided above, the “mask” argument for
<code>blup_prep</code> contains only the variable “id.” This setup
implies that all Stage 1 BLUEs for those individuals are masked. To
specifically mask grain yield and utilize CT as a secondary trait for
marker-assisted selection (MAS), we introduce a second variable named
“trait.”</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a>MAS <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a>  prep <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(wheat.blues, wheat.EEV, wheat.geno, ans2a<span class="sc">$</span>vars, </span>
<span id="cb104-4"><a href="#cb104-4" tabindex="-1"></a>                    <span class="at">mask=</span><span class="fu">data.frame</span>(<span class="at">id=</span>folds[[i]], <span class="at">trait=</span><span class="st">&quot;GY&quot;</span>))</span>
<span id="cb104-5"><a href="#cb104-5" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep, <span class="at">geno=</span>wheat.geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>, </span>
<span id="cb104-6"><a href="#cb104-6" tabindex="-1"></a>               <span class="at">index.coeff=</span><span class="fu">c</span>(<span class="at">GY=</span><span class="dv">1</span>, <span class="at">CT=</span><span class="dv">0</span>))</span>
<span id="cb104-7"><a href="#cb104-7" tabindex="-1"></a>  MAS <span class="ot">&lt;-</span> <span class="fu">rbind</span>(MAS, pred[pred<span class="sc">$</span>id <span class="sc">%in%</span> folds[[i]],])</span>
<span id="cb104-8"><a href="#cb104-8" tabindex="-1"></a>}</span>
<span id="cb104-9"><a href="#cb104-9" tabindex="-1"></a></span>
<span id="cb104-10"><a href="#cb104-10" tabindex="-1"></a>ans <span class="ot">&lt;-</span> <span class="fu">merge</span>(MBS,MAS,<span class="at">by=</span><span class="st">&quot;id&quot;</span>)</span>
<span id="cb104-11"><a href="#cb104-11" tabindex="-1"></a></span>
<span id="cb104-12"><a href="#cb104-12" tabindex="-1"></a><span class="co">#This figure shows that using CT increased the reliability of genomic prediction by 0.2 on average.</span></span>
<span id="cb104-13"><a href="#cb104-13" tabindex="-1"></a><span class="fu">ggplot</span>(ans,<span class="fu">aes</span>(<span class="at">x=</span>r2.x, <span class="at">y=</span>r2.y)) <span class="sc">+</span> </span>
<span id="cb104-14"><a href="#cb104-14" tabindex="-1"></a>  <span class="fu">geom_hex</span>() <span class="sc">+</span> </span>
<span id="cb104-15"><a href="#cb104-15" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb104-16"><a href="#cb104-16" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.8</span>),<span class="at">y=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="fl">0.8</span>)),<span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y),<span class="at">linetype=</span><span class="dv">2</span>) <span class="sc">+</span>  </span>
<span id="cb104-17"><a href="#cb104-17" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Reliability&quot;</span>) <span class="sc">+</span></span>
<span id="cb104-18"><a href="#cb104-18" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;MBS&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;MAS&quot;</span>)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<p>The figure above illustrates that the inclusion of CT data led to a
notable improvement in the reliability of genomic prediction, with an
average increase of 0.2.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a><span class="co">#Sommer</span></span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a><span class="co">#remove ungenotyped entries</span></span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a>wheat.blues.backup <span class="ot">&lt;-</span> wheat.blues</span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a>wheat.EEV.backup <span class="ot">&lt;-</span> wheat.EEV</span>
<span id="cb105-5"><a href="#cb105-5" tabindex="-1"></a>genotyped <span class="ot">&lt;-</span> (wheat.blues<span class="sc">$</span>id <span class="sc">%in%</span> <span class="fu">rownames</span>(wheat.geno<span class="sc">@</span>G))</span>
<span id="cb105-6"><a href="#cb105-6" tabindex="-1"></a>wheat.blues <span class="ot">&lt;-</span> wheat.blues[genotyped,]</span>
<span id="cb105-7"><a href="#cb105-7" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" tabindex="-1"></a><span class="co">#to wide format (needed for mmer solver)</span></span>
<span id="cb105-10"><a href="#cb105-10" tabindex="-1"></a>wheat.wide<span class="ot">&lt;-</span><span class="fu">reshape</span>(wheat.blues,<span class="at">idvar=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;env&quot;</span>),</span>
<span id="cb105-11"><a href="#cb105-11" tabindex="-1"></a>              <span class="at">v.names=</span><span class="fu">c</span>(<span class="st">&quot;BLUE&quot;</span>),<span class="at">direction=</span><span class="st">&quot;wide&quot;</span>,<span class="at">timevar=</span><span class="st">&quot;trait&quot;</span>)</span>
<span id="cb105-12"><a href="#cb105-12" tabindex="-1"></a>wheat.wide <span class="ot">&lt;-</span> wheat.wide[<span class="fu">order</span>(wheat.wide<span class="sc">$</span>env),]</span>
<span id="cb105-13"><a href="#cb105-13" tabindex="-1"></a><span class="fu">unique</span>(wheat.wide<span class="sc">$</span>env)</span></code></pre></div>
<pre><code>## [1] &quot;drought&quot;        &quot;severe drought&quot;</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a>n.trait <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wheat.blues<span class="sc">$</span>trait))</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a>Stage1Error.GY <span class="ot">&lt;-</span> <span class="fu">paste0</span>(wheat.wide<span class="sc">$</span>id, <span class="st">&quot;:&quot;</span>, <span class="st">&quot;GY:&quot;</span>, wheat.wide<span class="sc">$</span>env)</span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>wheat.wide<span class="ot">&lt;-</span><span class="fu">cbind</span>(wheat.wide, Stage1Error.GY)</span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a>Stage1Error.CT <span class="ot">&lt;-</span> <span class="fu">paste0</span>(wheat.wide<span class="sc">$</span>id, <span class="st">&quot;:&quot;</span>, <span class="st">&quot;CT:&quot;</span>, wheat.wide<span class="sc">$</span>env)</span>
<span id="cb107-8"><a href="#cb107-8" tabindex="-1"></a>wheat.wide<span class="ot">&lt;-</span><span class="fu">cbind</span>(wheat.wide, Stage1Error.CT)</span>
<span id="cb107-9"><a href="#cb107-9" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" tabindex="-1"></a><span class="fu">rownames</span>(wheat.EEV<span class="sc">$</span>drought) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rownames</span>(wheat.EEV<span class="sc">$</span>drought),<span class="st">&quot;:drought&quot;</span>)</span>
<span id="cb107-12"><a href="#cb107-12" tabindex="-1"></a><span class="fu">colnames</span>(wheat.EEV<span class="sc">$</span>drought) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">colnames</span>(wheat.EEV<span class="sc">$</span>drought),<span class="st">&quot;:drought&quot;</span>)</span>
<span id="cb107-13"><a href="#cb107-13" tabindex="-1"></a></span>
<span id="cb107-14"><a href="#cb107-14" tabindex="-1"></a><span class="fu">rownames</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>) <span class="ot">&lt;-</span> </span>
<span id="cb107-15"><a href="#cb107-15" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">rownames</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>),<span class="st">&quot;:severe drought&quot;</span>)</span>
<span id="cb107-16"><a href="#cb107-16" tabindex="-1"></a><span class="fu">colnames</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>) <span class="ot">&lt;-</span> </span>
<span id="cb107-17"><a href="#cb107-17" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">colnames</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>),<span class="st">&quot;:severe drought&quot;</span>)</span>
<span id="cb107-18"><a href="#cb107-18" tabindex="-1"></a></span>
<span id="cb107-19"><a href="#cb107-19" tabindex="-1"></a></span>
<span id="cb107-20"><a href="#cb107-20" tabindex="-1"></a></span>
<span id="cb107-21"><a href="#cb107-21" tabindex="-1"></a><span class="co">#Prepare EEV matrices for both traits:</span></span>
<span id="cb107-22"><a href="#cb107-22" tabindex="-1"></a>EEV.GY <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(<span class="fu">as.matrix</span>(wheat.EEV<span class="sc">$</span>drought),</span>
<span id="cb107-23"><a href="#cb107-23" tabindex="-1"></a>                     <span class="fu">as.matrix</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>))</span>
<span id="cb107-24"><a href="#cb107-24" tabindex="-1"></a><span class="fu">colnames</span>(EEV.GY) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(EEV.GY)</span>
<span id="cb107-25"><a href="#cb107-25" tabindex="-1"></a>EEV.GY <span class="ot">&lt;-</span> EEV.GY[wheat.wide<span class="sc">$</span>Stage1Error.GY,wheat.wide<span class="sc">$</span>Stage1Error.GY]</span>
<span id="cb107-26"><a href="#cb107-26" tabindex="-1"></a></span>
<span id="cb107-27"><a href="#cb107-27" tabindex="-1"></a></span>
<span id="cb107-28"><a href="#cb107-28" tabindex="-1"></a>EEV.CT <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(<span class="fu">as.matrix</span>(wheat.EEV<span class="sc">$</span>drought),</span>
<span id="cb107-29"><a href="#cb107-29" tabindex="-1"></a>                     <span class="fu">as.matrix</span>(wheat.EEV<span class="sc">$</span><span class="st">`</span><span class="at">severe drought</span><span class="st">`</span>))</span>
<span id="cb107-30"><a href="#cb107-30" tabindex="-1"></a><span class="fu">colnames</span>(EEV.CT) <span class="ot">&lt;-</span>  <span class="fu">rownames</span>(EEV.CT)</span>
<span id="cb107-31"><a href="#cb107-31" tabindex="-1"></a>EEV.CT <span class="ot">&lt;-</span> EEV.CT[wheat.wide<span class="sc">$</span>Stage1Error.CT,wheat.wide<span class="sc">$</span>Stage1Error.CT]</span>
<span id="cb107-32"><a href="#cb107-32" tabindex="-1"></a></span>
<span id="cb107-33"><a href="#cb107-33" tabindex="-1"></a>EEV.overlay <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(EEV.GY,EEV.CT)</span>
<span id="cb107-34"><a href="#cb107-34" tabindex="-1"></a><span class="fu">colnames</span>(EEV.overlay) <span class="ot">&lt;-</span>  <span class="fu">rownames</span>(EEV.overlay)</span>
<span id="cb107-35"><a href="#cb107-35" tabindex="-1"></a></span>
<span id="cb107-36"><a href="#cb107-36" tabindex="-1"></a>geno <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wheat.geno<span class="sc">@</span>G)</span></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a><span class="co">#1) estimate variances</span></span>
<span id="cb108-2"><a href="#cb108-2" tabindex="-1"></a>ansWheat <span class="ot">&lt;-</span> <span class="fu">mmer</span>(<span class="fu">cbind</span>(BLUE.GY,BLUE.CT) <span class="sc">~</span> env <span class="sc">-</span><span class="dv">1</span>, <span class="co">#Fixed </span></span>
<span id="cb108-3"><a href="#cb108-3" tabindex="-1"></a>                     <span class="at">random =</span> <span class="sc">~</span><span class="fu">vsr</span>(id, </span>
<span id="cb108-4"><a href="#cb108-4" tabindex="-1"></a>                                   <span class="at">Gtc=</span><span class="fu">unsm</span>(n.trait), </span>
<span id="cb108-5"><a href="#cb108-5" tabindex="-1"></a>                                   <span class="at">Gu =</span> geno) <span class="sc">+</span></span>
<span id="cb108-6"><a href="#cb108-6" tabindex="-1"></a>                       <span class="fu">vsr</span>(Stage1Error.GY,</span>
<span id="cb108-7"><a href="#cb108-7" tabindex="-1"></a>                           <span class="at">Gu=</span>EEV.GY, <span class="co">#known variance-covariance structure</span></span>
<span id="cb108-8"><a href="#cb108-8" tabindex="-1"></a>                           <span class="at">Gti=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">var</span>(wheat.wide<span class="sc">$</span>BLUE.GY),<span class="dv">0</span>,</span>
<span id="cb108-9"><a href="#cb108-9" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">0</span>),<span class="at">nrow=</span><span class="dv">2</span>), <span class="co">#initial</span></span>
<span id="cb108-10"><a href="#cb108-10" tabindex="-1"></a>                                <span class="co">#variance value. It&#39;s divided by the variance</span></span>
<span id="cb108-11"><a href="#cb108-11" tabindex="-1"></a>                                <span class="co">#of the BLUEs because Sommer uses varainces</span></span>
<span id="cb108-12"><a href="#cb108-12" tabindex="-1"></a>                                <span class="co">#scaled that way</span></span>
<span id="cb108-13"><a href="#cb108-13" tabindex="-1"></a>                           <span class="at">Gtc=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,</span>
<span id="cb108-14"><a href="#cb108-14" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">0</span>),<span class="at">nrow=</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb108-15"><a href="#cb108-15" tabindex="-1"></a>                       <span class="fu">vsr</span>(Stage1Error.CT,</span>
<span id="cb108-16"><a href="#cb108-16" tabindex="-1"></a>                           <span class="at">Gu=</span>EEV.CT, <span class="co">#known variance-covariance structure</span></span>
<span id="cb108-17"><a href="#cb108-17" tabindex="-1"></a>                           <span class="at">Gti=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,</span>
<span id="cb108-18"><a href="#cb108-18" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">var</span>(wheat.wide<span class="sc">$</span>BLUE.CT)),<span class="at">nrow=</span><span class="dv">2</span>), <span class="co">#initial</span></span>
<span id="cb108-19"><a href="#cb108-19" tabindex="-1"></a>                                <span class="co">#variance value. It&#39;s divided by the variance</span></span>
<span id="cb108-20"><a href="#cb108-20" tabindex="-1"></a>                                <span class="co">#of the BLUEs because Sommer uses varainces</span></span>
<span id="cb108-21"><a href="#cb108-21" tabindex="-1"></a>                                <span class="co">#scaled that way</span></span>
<span id="cb108-22"><a href="#cb108-22" tabindex="-1"></a>                           <span class="at">Gtc=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,</span>
<span id="cb108-23"><a href="#cb108-23" tabindex="-1"></a>                                        <span class="dv">0</span>,<span class="dv">3</span>),<span class="at">nrow=</span><span class="dv">2</span>)),</span>
<span id="cb108-24"><a href="#cb108-24" tabindex="-1"></a>                     <span class="at">rcov=</span><span class="sc">~</span><span class="fu">vsr</span>(units,<span class="at">Gtc=</span><span class="fu">diag</span>(n.trait)),<span class="co">#this should be unstructured</span></span>
<span id="cb108-25"><a href="#cb108-25" tabindex="-1"></a>                 <span class="co">#but I&#39;m making it diagonal due to singularity problems</span></span>
<span id="cb108-26"><a href="#cb108-26" tabindex="-1"></a>                     <span class="at">data=</span> wheat.wide,</span>
<span id="cb108-27"><a href="#cb108-27" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb108-28"><a href="#cb108-28" tabindex="-1"></a>                     <span class="at">tolParInv =</span> <span class="fl">1e-1</span> <span class="co">#raise tolerance to help with singularity problems</span></span>
<span id="cb108-29"><a href="#cb108-29" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" tabindex="-1"></a><span class="co">#go back to long format (needed for mmec solver):</span></span>
<span id="cb109-2"><a href="#cb109-2" tabindex="-1"></a><span class="co">#BLUEs=NA for all GY entries:</span></span>
<span id="cb109-3"><a href="#cb109-3" tabindex="-1"></a>wheat.blues<span class="sc">$</span>BLUE[<span class="fu">which</span>(wheat.blues<span class="sc">$</span>trait<span class="sc">==</span><span class="st">&quot;GY&quot;</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb109-4"><a href="#cb109-4" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" tabindex="-1"></a>Stage1Error <span class="ot">&lt;-</span> <span class="fu">paste0</span>(wheat.blues<span class="sc">$</span>id,<span class="st">&quot;:&quot;</span>,</span>
<span id="cb109-7"><a href="#cb109-7" tabindex="-1"></a>                         wheat.blues<span class="sc">$</span>trait,<span class="st">&quot;:&quot;</span>,</span>
<span id="cb109-8"><a href="#cb109-8" tabindex="-1"></a>                         wheat.blues<span class="sc">$</span>env)</span>
<span id="cb109-9"><a href="#cb109-9" tabindex="-1"></a>wheat.blues <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wheat.blues,Stage1Error)</span>
<span id="cb109-10"><a href="#cb109-10" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" tabindex="-1"></a>EEV_full <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(EEV.GY,EEV.CT)</span>
<span id="cb109-12"><a href="#cb109-12" tabindex="-1"></a><span class="fu">colnames</span>(EEV_full) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(EEV_full)</span>
<span id="cb109-13"><a href="#cb109-13" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" tabindex="-1"></a></span>
<span id="cb109-15"><a href="#cb109-15" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" tabindex="-1"></a>TraitId <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;BLUE.&quot;</span>,wheat.blues<span class="sc">$</span>trait, <span class="st">&quot;:&quot;</span>, wheat.blues<span class="sc">$</span>id)</span>
<span id="cb109-17"><a href="#cb109-17" tabindex="-1"></a>wheat.blues <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wheat.blues, TraitId)</span>
<span id="cb109-18"><a href="#cb109-18" tabindex="-1"></a></span>
<span id="cb109-19"><a href="#cb109-19" tabindex="-1"></a>TxG <span class="ot">&lt;-</span> <span class="fu">kronecker</span>(ansWheat<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:id</span><span class="st">`</span>,geno, <span class="at">make.dimnames =</span> T)</span>
<span id="cb109-20"><a href="#cb109-20" tabindex="-1"></a>TxGinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(TxG)),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb109-21"><a href="#cb109-21" tabindex="-1"></a></span>
<span id="cb109-22"><a href="#cb109-22" tabindex="-1"></a>EEV_combined <span class="ot">&lt;-</span> <span class="fu">direct.sum</span>(EEV.GY,EEV.CT)</span>
<span id="cb109-23"><a href="#cb109-23" tabindex="-1"></a><span class="fu">colnames</span>(EEV_combined) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(EEV_combined)</span>
<span id="cb109-24"><a href="#cb109-24" tabindex="-1"></a>EEVInv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(EEV_combined)),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb109-25"><a href="#cb109-25" tabindex="-1"></a></span>
<span id="cb109-26"><a href="#cb109-26" tabindex="-1"></a>Rmat <span class="ot">&lt;-</span> ansWheat<span class="sc">$</span>sigma_scaled<span class="sc">$</span><span class="st">`</span><span class="at">u:units</span><span class="st">`</span>[<span class="fu">paste0</span>(<span class="st">&quot;BLUE.&quot;</span>,wheat.blues<span class="sc">$</span>trait),</span>
<span id="cb109-27"><a href="#cb109-27" tabindex="-1"></a>                                        <span class="fu">paste0</span>(<span class="st">&quot;BLUE.&quot;</span>,wheat.blues<span class="sc">$</span>trait)]</span>
<span id="cb109-28"><a href="#cb109-28" tabindex="-1"></a>Rinv <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(Rmat)<span class="sc">+</span><span class="fl">1e-4</span><span class="sc">*</span><span class="fu">diag</span>(<span class="fu">nrow</span>(Rmat))),<span class="at">Class=</span><span class="st">&quot;dgCMatrix&quot;</span>)</span>
<span id="cb109-29"><a href="#cb109-29" tabindex="-1"></a><span class="fu">rownames</span>(Rinv) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;u&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Rinv)) <span class="co">#sommer naming convention for residuals</span></span>
<span id="cb109-30"><a href="#cb109-30" tabindex="-1"></a><span class="fu">colnames</span>(Rinv) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;u&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Rinv)) <span class="co">#sommer naming convention for residuals</span></span>
<span id="cb109-31"><a href="#cb109-31" tabindex="-1"></a></span>
<span id="cb109-32"><a href="#cb109-32" tabindex="-1"></a></span>
<span id="cb109-33"><a href="#cb109-33" tabindex="-1"></a><span class="fu">dim</span>(wheat.blues)</span></code></pre></div>
<pre><code>## [1] 2228    6</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" tabindex="-1"></a><span class="fu">dim</span>(EEV_combined)</span></code></pre></div>
<pre><code>## [1] 2228 2228</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a><span class="fu">dim</span>(Rmat)</span></code></pre></div>
<pre><code>## [1] 2228 2228</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" tabindex="-1"></a><span class="fu">dim</span>(TxG)</span></code></pre></div>
<pre><code>## [1] 1114 1114</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(wheat.blues<span class="sc">$</span>TraitId))</span></code></pre></div>
<pre><code>## [1] 1114</code></pre>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" tabindex="-1"></a><span class="co">#2) Fix all variances and calculate BLUPs</span></span>
<span id="cb119-2"><a href="#cb119-2" tabindex="-1"></a><span class="co">#Input known variance-covariance structures estimated from the previous model</span></span>
<span id="cb119-3"><a href="#cb119-3" tabindex="-1"></a><span class="co">#use mmec solver here. We need mmec because</span></span>
<span id="cb119-4"><a href="#cb119-4" tabindex="-1"></a><span class="co">#mmer doesn&#39;t allow us to fix the residual variance</span></span>
<span id="cb119-5"><a href="#cb119-5" tabindex="-1"></a>ans2Wheat <span class="ot">&lt;-</span> <span class="fu">mmec</span>(BLUE <span class="sc">~</span> env <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb119-6"><a href="#cb119-6" tabindex="-1"></a>                     <span class="at">random =</span> <span class="sc">~</span><span class="fu">vsc</span>(<span class="fu">isc</span>(TraitId,</span>
<span id="cb119-7"><a href="#cb119-7" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb119-8"><a href="#cb119-8" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb119-9"><a href="#cb119-9" tabindex="-1"></a>                                  <span class="at">Gu =</span> TxGinv) <span class="sc">+</span> <span class="co">#addtitive genotypic</span></span>
<span id="cb119-10"><a href="#cb119-10" tabindex="-1"></a>                       <span class="fu">vsc</span>(<span class="fu">isc</span>(Stage1Error,</span>
<span id="cb119-11"><a href="#cb119-11" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb119-12"><a href="#cb119-12" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb119-13"><a href="#cb119-13" tabindex="-1"></a>                                  <span class="at">Gu =</span> EEVInv),</span>
<span id="cb119-14"><a href="#cb119-14" tabindex="-1"></a>                     <span class="at">rcov=</span><span class="sc">~</span><span class="fu">vsc</span>(<span class="fu">isc</span>(units,</span>
<span id="cb119-15"><a href="#cb119-15" tabindex="-1"></a>                                   <span class="at">theta =</span> <span class="fu">matrix</span>(<span class="dv">1</span>),</span>
<span id="cb119-16"><a href="#cb119-16" tabindex="-1"></a>                                  <span class="at">thetaC =</span>  <span class="fu">matrix</span>(<span class="dv">3</span>)),</span>
<span id="cb119-17"><a href="#cb119-17" tabindex="-1"></a>                               <span class="at">Gu =</span> Rinv), <span class="co">#residuals. isc(units) means that we</span></span>
<span id="cb119-18"><a href="#cb119-18" tabindex="-1"></a>                     <span class="co">#assume identity variance-covariance structure for the</span></span>
<span id="cb119-19"><a href="#cb119-19" tabindex="-1"></a>                     <span class="co">#&quot;units&quot; effect (residuals are always called &quot;units&quot;)</span></span>
<span id="cb119-20"><a href="#cb119-20" tabindex="-1"></a>                     <span class="at">data=</span> wheat.blues,</span>
<span id="cb119-21"><a href="#cb119-21" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb119-22"><a href="#cb119-22" tabindex="-1"></a>                     <span class="at">nIters=</span><span class="dv">1</span> <span class="co">#as we already know the variances, a single</span></span>
<span id="cb119-23"><a href="#cb119-23" tabindex="-1"></a>                    <span class="co">#REML iteration is enough</span></span>
<span id="cb119-24"><a href="#cb119-24" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Version out of date. Please update sommer to the newest version using:
## install.packages(&#39;sommer&#39;) in a new session
##  Use the &#39;dateWarning&#39; argument to disable the warning message.Adding additional levels of Gu in the model matrix of &#39;TraitId&#39; 
## Adding additional levels of Gu in the model matrix of &#39;Stage1Error&#39; 
## iteration    LogLik     wall    cpu(sec)   restrained
##     1      -1067.54   15:40:27      31           0</code></pre>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" tabindex="-1"></a><span class="co">#Get shorter names</span></span>
<span id="cb121-2"><a href="#cb121-2" tabindex="-1"></a><span class="fu">names</span>(ans2Wheat<span class="sc">$</span>uList) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Additive&quot;</span>, <span class="st">&quot;Stage1Error&quot;</span>)</span>
<span id="cb121-3"><a href="#cb121-3" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" tabindex="-1"></a>SommerBLUPs.yield<span class="ot">&lt;-</span>ans2Wheat<span class="sc">$</span>uList<span class="sc">$</span>Additive[<span class="fu">grep</span>(<span class="st">&quot;GY&quot;</span>,</span>
<span id="cb121-7"><a href="#cb121-7" tabindex="-1"></a>                                                <span class="fu">rownames</span>(ans2Wheat<span class="sc">$</span>uList<span class="sc">$</span>Additive))]</span>
<span id="cb121-8"><a href="#cb121-8" tabindex="-1"></a><span class="fu">names</span>(SommerBLUPs.yield) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(ans2Wheat<span class="sc">$</span>uList<span class="sc">$</span>Additive)[<span class="fu">grep</span>(<span class="st">&quot;GY&quot;</span>,</span>
<span id="cb121-9"><a href="#cb121-9" tabindex="-1"></a>                                                <span class="fu">rownames</span>(ans2Wheat<span class="sc">$</span>uList<span class="sc">$</span>Additive))]</span>
<span id="cb121-10"><a href="#cb121-10" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" tabindex="-1"></a></span>
<span id="cb121-12"><a href="#cb121-12" tabindex="-1"></a><span class="co"># #StageWise</span></span>
<span id="cb121-13"><a href="#cb121-13" tabindex="-1"></a><span class="co"># #Non-masked</span></span>
<span id="cb121-14"><a href="#cb121-14" tabindex="-1"></a><span class="co"># prep1 &lt;- blup_prep(wheat.blues.backup, wheat.EEV.backup, wheat.geno, ans2a$vars)</span></span>
<span id="cb121-15"><a href="#cb121-15" tabindex="-1"></a></span>
<span id="cb121-16"><a href="#cb121-16" tabindex="-1"></a><span class="co">#Mask GY</span></span>
<span id="cb121-17"><a href="#cb121-17" tabindex="-1"></a>prep2 <span class="ot">&lt;-</span> <span class="fu">blup_prep</span>(wheat.blues.backup, wheat.EEV.backup, wheat.geno, ans2a<span class="sc">$</span>vars, </span>
<span id="cb121-18"><a href="#cb121-18" tabindex="-1"></a>                    <span class="at">mask=</span><span class="fu">data.frame</span>(<span class="at">trait=</span><span class="st">&quot;GY&quot;</span>))</span>
<span id="cb121-19"><a href="#cb121-19" tabindex="-1"></a></span>
<span id="cb121-20"><a href="#cb121-20" tabindex="-1"></a></span>
<span id="cb121-21"><a href="#cb121-21" tabindex="-1"></a>index2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">GY=</span><span class="dv">1</span>, <span class="at">CT=</span><span class="dv">0</span>)</span>
<span id="cb121-22"><a href="#cb121-22" tabindex="-1"></a><span class="co">#ASRemlBLUPs.GY_non_masked &lt;- blup(prep1, wheat.geno, what=&quot;BV&quot;, index.coeff=index2)</span></span>
<span id="cb121-23"><a href="#cb121-23" tabindex="-1"></a>ASRemlBLUPs.GY <span class="ot">&lt;-</span> <span class="fu">blup</span>(prep2, wheat.geno, <span class="at">what=</span><span class="st">&quot;BV&quot;</span>, <span class="at">index.coeff=</span>index2)</span>
<span id="cb121-24"><a href="#cb121-24" tabindex="-1"></a></span>
<span id="cb121-25"><a href="#cb121-25" tabindex="-1"></a></span>
<span id="cb121-26"><a href="#cb121-26" tabindex="-1"></a><span class="co">#BLUPs</span></span>
<span id="cb121-27"><a href="#cb121-27" tabindex="-1"></a><span class="co">#High correlation</span></span>
<span id="cb121-28"><a href="#cb121-28" tabindex="-1"></a><span class="fu">cor</span>(ASRemlBLUPs.GY<span class="sc">$</span>value, <span class="co">#StageWise, masked</span></span>
<span id="cb121-29"><a href="#cb121-29" tabindex="-1"></a>SommerBLUPs.yield[<span class="fu">match</span>(<span class="fu">paste0</span>(<span class="st">&quot;BLUE.GY:&quot;</span>,ASRemlBLUPs.GY<span class="sc">$</span>id)</span>
<span id="cb121-30"><a href="#cb121-30" tabindex="-1"></a>                        ,<span class="fu">names</span>(SommerBLUPs.yield))]) <span class="co">#Sommer, masked</span></span></code></pre></div>
<pre><code>## [1] 0.9281192</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" tabindex="-1"></a><span class="co"># save.image(&quot;workspace3.RData&quot;)</span></span>
<span id="cb123-2"><a href="#cb123-2" tabindex="-1"></a><span class="co">#save(ans2open, ans2mask, ansWheat, ans2Wheat, file = &quot;Vignette3Models.RData&quot;)</span></span></code></pre></div>
<p>The results of Sommer and StageWise, while not exactly equivalet, are
very similar and present very high correlation between them.</p>
</div>
<div id="bibliography" class="section level1">
<h1>Bibliography</h1>
<p>Damesa, T.M., Möhring, J., Worku, M. and Piepho, H.-P. (2017), One
Step at a Time: Stage-Wise Analysis of a Series of Experiments. Agronomy
Journal, 109: 845-857.</p>
<p>Endelman, J. B. (2023). Fully efficient, two-stage analysis of
multi-environment trials with directional dominance and multi-trait
genomic selection. Theoretical and Applied Genetics, 136(4), 65.</p>
<p>Frahm, G. (2004). Generalized elliptical distributions: theory and
applications (Doctoral dissertation, Universität zu Köln).</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
